<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" type="text/css" href="/css/button.css">
    <link rel="stylesheet" type="text/css" href="/css/main.css">
    <link rel="stylesheet" type="text/css" href="/css/section.css">
    <link rel="stylesheet" type="text/css" href="/css/typography.css">

    <link rel="icon" type="image/png" href="/images/favicon.png">
    <title>EnergyMe</title>
    <style>
        .header {
            font-size: 96px;
            margin-bottom: 10px;
            text-align: center;
        }

        .subheader {
            font-size: 32px;
            margin-bottom: 20px;
            text-align: center;
            color: #808080;
        }

        .voltage-box {
            text-align: center;
            font-size: 20px;
            margin-bottom: 20px;
            margin-top: 5px;
        }

        .channels-box {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
        }

        .channel-box {
            width: 18%;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-sizing: border-box;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
            padding: 10px;
            text-align: center;
        }

        .channel-label {
            font-size: 24px;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .channel-value {
            font-style: italic;
            color: #808080;
        }
    </style>
</head>

<body>

    <div class="header">EnergyMe</div>
    <div class="subheader">Home</div>

    <div class="buttonNavigation-container">
        <a class="buttonNavigation" type="inner" href="/info">Info</a>
        <a class="buttonNavigation" type="inner" href="/configuration">Configuration</a>
        <a class="buttonNavigation" type="inner" href="/update">Update</a>
    </div>

    <div class="section-box">
        <div id="voltage" class="voltage-box"></div>
        <div id="channels" class="channels-box"></div>
    </div>

    <div class="section-box">
        <div id="consumption-chart">
            <canvas id="consumption-chart-canvas"></canvas>
        </div>
    </div>

    <div class="section-box">
        <div id="pie-chart">
            <canvas id="pie-chart-canvas"></canvas>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>

<script>
    var colors = [
        'rgba(0,123,255,0.5)', 'rgba(255,0,0,0.5)', 'rgba(0,255,0,0.5)', 'rgba(255,255,0,0.5)', 'rgba(0,255,255,0.5)',
        'rgba(123,0,255,0.5)', 'rgba(255,0,123,0.5)', 'rgba(0,255,123,0.5)', 'rgba(255,255,123,0.5)', 'rgba(123,255,0,0.5)',
        'rgba(0,123,0,0.5)', 'rgba(123,0,0,0.5)', 'rgba(0,0,123,0.5)', 'rgba(123,123,123,0.5)', 'rgba(255,255,255,0.5)',
        'rgba(0,0,255,0.5)', 'rgba(255,0,255,0.5)', 'rgba(255,123,0,0.5)'
    ];

    function getConsumptionData() {
        channelData = getChannelData();

        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                consumptionData = JSON.parse(this.responseText);

                var otherData = [];
                for (var i = 0; i < consumptionData[0].activeEnergy.daily.length; i++) {
                    var otherValue = consumptionData[0].activeEnergy.daily[i].value;
                    for (var channel in consumptionData) {
                        if (channel !== "0") {
                            if (consumptionData[channel].activeEnergy.daily.length > i) {
                                otherValue -= consumptionData[channel].activeEnergy.daily[i].value;
                            }
                        }
                    }
                    otherData.push({
                        date: consumptionData[0].activeEnergy.daily[i].date,
                        value: otherValue
                    });
                }
                consumptionData["Other"] = {
                    activeEnergy: {
                        total: 0,
                        daily: otherData
                    },
                    reactiveEnergy: {
                        total: 0,
                        daily: []
                    },
                    apparentEnergy: {
                        total: 0,
                        daily: []
                    }
                };

                for (var channel in consumptionData) {
                    var dailyData = [];
                    for (var i = 0; i < consumptionData[channel].activeEnergy.daily.length; i++) {
                        var currentValue = consumptionData[channel].activeEnergy.daily[i].value;
                        var previousValue = i > 0 ? consumptionData[channel].activeEnergy.daily[i - 1].value : 0;
                        var dailyValue = currentValue - previousValue;
                        dailyData.push({
                            date: consumptionData[channel].activeEnergy.daily[i].date,
                            value: dailyValue // Display data with 2 decimals
                        });
                    }
                    consumptionData[channel] = dailyData;
                }

                delete consumptionData[0];
                for (var channel in consumptionData) {
                    if (consumptionData[channel].length === 0) {
                        delete consumptionData[channel];
                    }
                }

                for (var channel in consumptionData) {
                    for (channelSingleData in channelData) {
                        if (channelData[channelSingleData].index === parseInt(channel)) {
                            consumptionData[channel].label = channelData[channelSingleData].label;
                        }
                    }
                }
                consumptionData["Other"].label = "Other";

                plotConsumptionChart(consumptionData);
                plotPieChart(consumptionData);
            }
        };
        xhttp.open("GET", "/rest/file/energy.json", true);
        xhttp.send();
    }

    function plotConsumptionChart(consumptionData) {
        var labels = consumptionData.Other.map(function (item) {
            return item.date;
        });

        var datasets = [];

        var i = 0;
        for (var channel in consumptionData) {
            var data = consumptionData[channel].map(function (item) {
                return item.value.toFixed(2); // Display data with 2 decimals
            });

            datasets.push({
                label: consumptionData[channel].label,
                data: data,
                backgroundColor: colors[i % colors.length],
                borderColor: colors[i % colors.length],
                borderWidth: 1
            });

            i++;
        }

        var ctx = document.getElementById('consumption-chart-canvas').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                scales: {
                    x: {
                        stacked: true
                    },
                    y: {
                        stacked: true,
                        title: {
                            display: true,
                            text: 'kWh'
                        }
                    }
                }
            }
        });
    }

    function plotPieChart(consumptionData) {
        var labels = [];
        var data = [];

        var totalConsumption = 0;
        for (var channel in consumptionData) {
            var total = consumptionData[channel].reduce(function (acc, item) {
                return acc + item.value;
            }, 0);
            totalConsumption += total;
        }

        var i = 0;
        for (var channel in consumptionData) {
            var total = consumptionData[channel].reduce(function (acc, item) {
                return acc + item.value;
            }, 0);

            var percentage = ((total / totalConsumption) * 100).toFixed(1);

            labels.push(consumptionData[channel].label + ' (' + percentage + '%)');
            data.push(total);
            i++;
        }

        var ctx = document.getElementById('pie-chart-canvas').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut', // Use 'doughnut' type for a pie chart with a hole inside
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors.slice(0, labels.length),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    function updatePowerData() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                powerData = JSON.parse(this.responseText);

                document.getElementById("voltage").innerHTML = powerData[0].data.voltage.toFixed(1) + ' V';

                var powerDataHtml = '';
                var channelCount = 0;
                var totalPower = 0;
                for (var channel in powerData) {
                    var label = powerData[channel].label;
                    var activePower = powerData[channel].data.activePower.toFixed(0);

                    powerDataHtml += '<div class="channel-box">';
                    powerDataHtml += '<div class="channel-label">' + label + '</div>';
                    powerDataHtml += '<div class="channel-value">' + activePower + ' W</div>';
                    powerDataHtml += '</div>';

                    if (channelCount > 0) {
                        totalPower += parseFloat(activePower);
                    }
                    channelCount++;
                }

                if (channelCount > 1) {
                    var otherPower = (parseFloat(powerData[0].data.activePower) - totalPower).toFixed(0);
                    powerDataHtml += '<div class="channel-box">';
                    powerDataHtml += '<div class="channel-label">Other</div>';
                    powerDataHtml += '<div class="channel-value">' + otherPower + ' W</div>';
                    powerDataHtml += '</div>';
                }

                document.getElementById("channels").innerHTML = powerDataHtml;
            }
        };
        xhttp.open("GET", "/rest/meter", true);
        xhttp.send();
    }

    function getChannelData() {
        var xhttp = new XMLHttpRequest();
        xhttp.open("GET", "/rest/get-channel", false);
        xhttp.send();
        return JSON.parse(xhttp.responseText);
    }

    updatePowerData();

    getConsumptionData();

    setInterval(function () {
        updatePowerData();
    }, 1000);

</script>

</html>