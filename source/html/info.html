<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" type="text/css" href="/css/button.css">
    <link rel="stylesheet" type="text/css" href="/css/styles.css">
    <link rel="stylesheet" type="text/css" href="/css/section.css">
    <link rel="stylesheet" type="text/css" href="/css/typography.css">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">

    <script src="/js/api-client.js"></script>

    <title>üìä Device Information</title>
    <style>
        /* Modern Info Page Styles */
        .info-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .info-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafb 100%);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .info-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-icon {
            font-size: 2.5rem;
            margin-right: 15px;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f5f5f5;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            display: flex;
            align-items: center;
            font-weight: 500;
            color: #555;
            font-size: 0.95rem;
        }

        .info-label .emoji {
            margin-right: 8px;
            font-size: 1.1rem;
        }

        .info-value {
            font-weight: 600;
            color: #2c3e50;
            text-align: right;
            font-size: 0.95rem;
        }

        .status-indicator {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-excellent { background: #d4f5d4; color: #2d7d32; }
        .status-good { background: #e8f5e8; color: #388e3c; }
        .status-warning { background: #fff3cd; color: #f57c00; }
        .status-critical { background: #f8d7da; color: #d32f2f; }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .progress-good { background: linear-gradient(90deg, #4caf50, #66bb6a); }
        .progress-warning { background: linear-gradient(90deg, #ff9800, #ffb74d); }
        .progress-critical { background: linear-gradient(90deg, #f44336, #ef5350); }

        .update-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .update-indicator.show {
            opacity: 1;
        }

        .page-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .page-subtitle {
            font-size: 1.1rem;
            color: #7f8c8d;
            margin: 0;
        }

        @media (max-width: 768px) {
            .info-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .info-container {
                padding: 10px;
            }
            
            .page-title {
                font-size: 1.8rem;
            }
            
            .page-subtitle {
                font-size: 1rem;
            }
            
            .info-card {
                padding: 18px;
                border-radius: 12px;
            }
            
            .card-header {
                margin-bottom: 15px;
                padding-bottom: 12px;
            }
            
            .card-title {
                font-size: 1.1rem;
            }
            
            .card-icon {
                font-size: 1.3rem;
                margin-right: 8px;
            }
            
            .info-item {
                margin-bottom: 12px;
                padding: 8px 0;
            }
            
            .info-label {
                font-size: 0.9rem;
                margin-bottom: 4px;
            }
            
            .info-value {
                font-size: 0.85rem;
                word-break: break-all;
                line-height: 1.3;
            }
            
            .emoji {
                font-size: 0.9rem;
            }
            
            .status-indicator {
                padding: 4px 8px;
                font-size: 0.8rem;
            }
            
            .update-indicator {
                font-size: 0.9rem;
                padding: 8px 12px;
            }
        }
        
        @media (max-width: 480px) {
            .info-container {
                padding: 8px;
            }
            
            .page-title {
                font-size: 1.6rem;
            }
            
            .page-subtitle {
                font-size: 0.9rem;
            }
            
            .info-card {
                padding: 15px;
                border-radius: 10px;
            }
            
            .card-title {
                font-size: 1rem;
            }
            
            .info-label {
                font-size: 0.85rem;
            }
            
            .info-value {
                font-size: 0.8rem;
            }
            
            .emoji {
                font-size: 0.8rem;
            }
        }
    </style>
</head>

<body>
    <div class="buttonNavigation-container">
        <a class="buttonNavigation" type="home" href="/">üè† Home</a>
    </div>

    <div class="update-indicator" id="updateIndicator">
        ‚úÖ Data Updated
    </div>

    <div class="info-container">
        <div class="page-header">
            <h1 class="page-title">üìä Device Information</h1>
            <p class="page-subtitle">Real-time system status and configuration details</p>
        </div>

        <div class="info-grid">
            <!-- Product Information Card -->
            <div class="info-card">
                <div class="card-header">
                    <div class="card-icon">üè∑Ô∏è</div>
                    <h3 class="card-title">Product Information</h3>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üè¢</span>Company</span>
                    <span class="info-value" id="companyName">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üì¶</span>Product</span>
                    <span class="info-value" id="productName">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üìù</span>Description</span>
                    <span class="info-value" id="productDescription">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üë§</span>Author</span>
                    <span class="info-value" id="author">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üîó</span>GitHub</span>
                    <span class="info-value" id="githubUrl">Loading...</span>
                </div>
            </div>

            <!-- Firmware Information Card -->
            <div class="info-card">
                <div class="card-header">
                    <div class="card-icon">üíæ</div>
                    <h3 class="card-title">Firmware Information</h3>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üî¢</span>Version</span>
                    <span class="info-value" id="buildVersion">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üìÖ</span>Build Date</span>
                    <span class="info-value" id="buildDate">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üïí</span>Build Time</span>
                    <span class="info-value" id="buildTime">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üîê</span>Sketch MD5</span>
                    <span class="info-value" id="sketchMD5">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üìÇ</span>Partition</span>
                    <span class="info-value" id="partitionAppName">Loading...</span>
                </div>
            </div>

            <!-- Hardware Information Card -->
            <div class="info-card">
                <div class="card-header">
                    <div class="card-icon">üîß</div>
                    <h3 class="card-title">Hardware Information</h3>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üíª</span>Chip Model</span>
                    <span class="info-value" id="chipModel">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üîÑ</span>Chip Revision</span>
                    <span class="info-value" id="chipRevision">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">‚ö°</span>CPU Cores</span>
                    <span class="info-value" id="chipCores">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üîÅ</span>CPU Frequency</span>
                    <span class="info-value" id="cpuFrequency">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üíæ</span>Flash Size</span>
                    <span class="info-value" id="flashSize">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üöÄ</span>PSRAM Size</span>
                    <span class="info-value" id="psramSize">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üå°Ô∏è</span>Temperature</span>
                    <span class="info-value" id="temperature">Loading...</span>
                </div>
            </div>

            <!-- System Status Card -->
            <div class="info-card">
                <div class="card-header">
                    <div class="card-icon">‚è±Ô∏è</div>
                    <h3 class="card-title">System Status</h3>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">‚è∞</span>Uptime</span>
                    <span class="info-value" id="uptime">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üïê</span>Current Time</span>
                    <span class="info-value" id="currentTime">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üîÑ</span>Reset Count</span>
                    <span class="info-value" id="resetCount">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üí•</span>Crash Count</span>
                    <span class="info-value" id="crashCount">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üîô</span>Last Reset</span>
                    <span class="info-value" id="lastResetReason">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üÜî</span>Device ID</span>
                    <span class="info-value" id="deviceId">Loading...</span>
                </div>
            </div>

            <!-- Memory Information Card -->
            <div class="info-card">
                <div class="card-header">
                    <div class="card-icon">üß†</div>
                    <h3 class="card-title">Memory Usage</h3>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üìä</span>Heap Memory</span>
                    <span class="info-value" id="heapMemory">Loading...</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="heapProgressBar"></div>
                </div>
                <div class="info-item" style="margin-top: 15px;">
                    <span class="info-label"><span class="emoji">üöÄ</span>PSRAM Memory</span>
                    <span class="info-value" id="psramMemory">Loading...</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="psramProgressBar"></div>
                </div>
            </div>

            <!-- Storage Information Card -->
            <div class="info-card">
                <div class="card-header">
                    <div class="card-icon">üíæ</div>
                    <h3 class="card-title">Storage Usage</h3>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üìÅ</span>LittleFS</span>
                    <span class="info-value" id="littlefsStorage">Loading...</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="littlefsProgressBar"></div>
                </div>
                <div class="info-item" style="margin-top: 15px;">
                    <span class="info-label"><span class="emoji">‚öôÔ∏è</span>NVS Storage</span>
                    <span class="info-value" id="nvsStorage">Loading...</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="nvsProgressBar"></div>
                </div>
            </div>

            <!-- Network Information Card -->
            <div class="info-card">
                <div class="card-header">
                    <div class="card-icon">üì°</div>
                    <h3 class="card-title">Network Status</h3>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üì∂</span>WiFi Status</span>
                    <span class="info-value status-indicator" id="wifiStatus">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üè†</span>SSID</span>
                    <span class="info-value" id="wifiSsid">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üåê</span>IP Address</span>
                    <span class="info-value" id="wifiLocalIp">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üì°</span>Signal Strength</span>
                    <span class="info-value" id="wifiRssi">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üîó</span>MAC Address</span>
                    <span class="info-value" id="wifiMacAddress">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üö™</span>Gateway</span>
                    <span class="info-value" id="wifiGateway">Loading...</span>
                </div>
            </div>

            <!-- SDK Information Card -->
            <div class="info-card">
                <div class="card-header">
                    <div class="card-icon">‚öôÔ∏è</div>
                    <h3 class="card-title">SDK Information</h3>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üìö</span>SDK Version</span>
                    <span class="info-value" id="sdkVersion">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üîß</span>Core Version</span>
                    <span class="info-value" id="coreVersion">Loading...</span>
                </div>
            </div>

            <!-- ADE7953 Statistics Card -->
            <div class="info-card">
                <div class="card-header">
                    <div class="card-icon">‚ö°</div>
                    <h3 class="card-title">ADE7953 Energy Meter</h3>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üìä</span>Total Interrupts</span>
                    <span class="info-value" id="ade7953TotalInterrupts">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">‚úÖ</span>Handled Interrupts</span>
                    <span class="info-value" id="ade7953HandledInterrupts">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üìà</span>Successful Readings</span>
                    <span class="info-value" id="ade7953Readings">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">‚ùå</span>Failed Readings</span>
                    <span class="info-value" id="ade7953ReadingFailures">Loading...</span>
                </div>
            </div>

            <!-- Communication Statistics Card TODO: review and ensure all the proper information are shown here--> 
            <div class="info-card">
                <div class="card-header">
                    <div class="card-icon">üì°</div>
                    <h3 class="card-title">Communication Statistics</h3>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üì§</span>MQTT Messages</span>
                    <span class="info-value" id="mqttMessages">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üîó</span>MQTT Connections</span>
                    <span class="info-value" id="mqttConnections">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üåê</span>Web Requests</span>
                    <span class="info-value" id="webServerRequests">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üìä</span>InfluxDB Uploads</span>
                    <span class="info-value" id="influxdbUploads">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üîß</span>Modbus Requests</span>
                    <span class="info-value" id="modbusRequests">Loading...</span>
                </div>
            </div>

            <!-- Logging Statistics Card -->
            <div class="info-card">
                <div class="card-header">
                    <div class="card-icon">üìù</div>
                    <h3 class="card-title">Logging Statistics</h3>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üêõ</span>Debug Messages</span>
                    <span class="info-value" id="logDebug">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">‚ÑπÔ∏è</span>Info Messages</span>
                    <span class="info-value" id="logInfo">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">‚ö†Ô∏è</span>Warning Messages</span>
                    <span class="info-value" id="logWarning">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üö®</span>Error Messages</span>
                    <span class="info-value" id="logError">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üíÄ</span>Fatal Messages</span>
                    <span class="info-value" id="logFatal">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label"><span class="emoji">üìâ</span>Dropped Messages</span>
                    <span class="info-value" id="logDropped">Loading...</span>
                </div>
            </div>

            <!-- System Task Stack Usage Card -->
            <div class="info-card">
                <div class="card-header">
                    <div class="card-icon">‚öôÔ∏è</div>
                    <h3 class="card-title">System Task Stack Usage</h3>
                </div>
                <div id="systemTaskStackContainer">
                    <!-- System tasks will be dynamically added here -->
                </div>
            </div>

            <!-- Application Task Stack Usage Card -->
            <div class="info-card">
                <div class="card-header">
                    <div class="card-icon">üîß</div>
                    <h3 class="card-title">Application Task Stack Usage</h3>
                </div>
                <div id="appTaskStackContainer">
                    <!-- Application tasks will be dynamically added here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables for system info
        let systemInfo = null;

        function showUpdateIndicator() {
            const indicator = document.getElementById('updateIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        async function fetchSystemInfo() {
            try {
                // Fetch both system info and statistics in parallel
                const [systemInfoData, statisticsData] = await Promise.all([
                    energyApi.getSystemInfo(),
                    energyApi.get('system/statistics')
                ]);
                
                systemInfo = systemInfoData;
                displaySystemInfo(systemInfo);
                displayStatistics(statisticsData);
                showUpdateIndicator();
            } catch (error) {
                console.error('Failed to fetch system info:', error);
                // Show error state in UI
                document.querySelectorAll('.info-value').forEach(el => {
                    if (el.textContent === 'Loading...') {
                        el.textContent = 'Error loading data';
                        el.style.color = '#f44336';
                    }
                });
            }
        }

        function displaySystemInfo(data) {
            // Product Information
            document.getElementById('companyName').textContent = data.static.product.companyName;
            document.getElementById('productName').textContent = data.static.product.fullProductName;
            document.getElementById('productDescription').textContent = data.static.product.productDescription;
            document.getElementById('author').textContent = `${data.static.product.author} (${data.static.product.authorEmail})`;
            
            const githubElement = document.getElementById('githubUrl');
            githubElement.innerHTML = `<a href="${data.static.product.githubUrl}" target="_blank" style="color: #0066cc; text-decoration: none;">View on GitHub</a>`;

            // Firmware Information
            document.getElementById('buildVersion').textContent = data.static.firmware.buildVersion;
            document.getElementById('buildDate').textContent = data.static.firmware.buildDate;
            document.getElementById('buildTime').textContent = data.static.firmware.buildTime;
            document.getElementById('sketchMD5').textContent = data.static.firmware.sketchMD5.substring(0, 16) + '...';
            document.getElementById('partitionAppName').textContent = data.static.firmware.partitionAppName;

            // Hardware Information
            document.getElementById('chipModel').textContent = data.static.hardware.chipModel;
            document.getElementById('chipRevision').textContent = `Rev ${data.static.hardware.chipRevision}`;
            document.getElementById('chipCores').textContent = `${data.static.hardware.chipCores} cores`;
            document.getElementById('cpuFrequency').textContent = `${data.static.hardware.cpuFrequencyMHz} MHz`;
            document.getElementById('flashSize').textContent = formatBytes(data.static.hardware.flashChipSizeBytes);
            document.getElementById('psramSize').textContent = formatBytes(data.static.hardware.psramSizeBytes);
            document.getElementById('temperature').textContent = `${data.dynamic.performance.temperatureCelsius.toFixed(1)}¬∞C`;

            // System Status
            document.getElementById('uptime').textContent = formatUptime(data.dynamic.time.uptimeMilliseconds);
            document.getElementById('currentTime').textContent = new Date(data.dynamic.time.currentTimestampIso).toLocaleString();
            document.getElementById('resetCount').textContent = `${data.static.monitoring.resetCount} (${data.static.monitoring.consecutiveResetCount} consecutive)`;
            document.getElementById('crashCount').textContent = `${data.static.monitoring.crashCount} (${data.static.monitoring.consecutiveCrashCount} consecutive)`;
            document.getElementById('lastResetReason').textContent = data.static.monitoring.lastResetReasonString;
            document.getElementById('deviceId').textContent = data.static.device.id;

            // Memory Information
            displayMemoryInfo(data.dynamic.memory);

            // Storage Information
            displayStorageInfo(data.dynamic.storage);

            // Network Information
            displayNetworkInfo(data.dynamic.network);

            // Task Information
            displayTaskInfo(data.dynamic.tasks);

            // SDK Information
            document.getElementById('sdkVersion').textContent = data.static.sdk.sdkVersion;
            document.getElementById('coreVersion').textContent = data.static.sdk.coreVersion;
        }

        function displayStatistics(stats) {
            // ADE7953 Statistics
            document.getElementById('ade7953TotalInterrupts').textContent = formatNumber(stats.ade7953.totalInterrupts);
            document.getElementById('ade7953HandledInterrupts').textContent = formatNumber(stats.ade7953.totalHandledInterrupts);
            document.getElementById('ade7953Readings').textContent = formatNumber(stats.ade7953.readingCount);
            
            const ade7953Failures = stats.ade7953.readingCountFailure;
            const ade7953FailureElement = document.getElementById('ade7953ReadingFailures');
            ade7953FailureElement.textContent = formatNumber(ade7953Failures);
            ade7953FailureElement.style.color = ade7953Failures > 0 ? '#f44336' : '#4caf50';

            // Communication Statistics
            document.getElementById('mqttMessages').textContent = `${formatNumber(stats.mqtt.messagesPublished)} (${stats.mqtt.messagesPublishedError} errors)`;
            document.getElementById('mqttConnections').textContent = `${formatNumber(stats.mqtt.connections)} (${stats.mqtt.connectionErrors} errors)`;
            document.getElementById('webServerRequests').textContent = `${formatNumber(stats.webServer.requests)} (${stats.webServer.requestsError} errors)`;
            document.getElementById('influxdbUploads').textContent = `${formatNumber(stats.influxdb.uploadCount)} (${stats.influxdb.uploadCountError} errors)`;
            document.getElementById('modbusRequests').textContent = `${formatNumber(stats.modbus.requests)} (${stats.modbus.requestsError} errors)`;

            // Logging Statistics
            document.getElementById('logDebug').textContent = formatNumber(stats.log.debug);
            document.getElementById('logInfo').textContent = formatNumber(stats.log.info);
            
            const logWarning = document.getElementById('logWarning');
            logWarning.textContent = formatNumber(stats.log.warning);
            logWarning.style.color = stats.log.warning > 0 ? '#ff9800' : '#4caf50';
            
            const logError = document.getElementById('logError');
            logError.textContent = formatNumber(stats.log.error);
            logError.style.color = stats.log.error > 0 ? '#f44336' : '#4caf50';
            
            const logFatal = document.getElementById('logFatal');
            logFatal.textContent = formatNumber(stats.log.fatal);
            logFatal.style.color = stats.log.fatal > 0 ? '#d32f2f' : '#4caf50';
            
            const logDropped = document.getElementById('logDropped');
            logDropped.textContent = formatNumber(stats.log.dropped);
            logDropped.style.color = stats.log.dropped > 0 ? '#f44336' : '#4caf50';
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        function displayMemoryInfo(memory) {
            // Heap Memory
            const heapUsedPercentage = memory.heap.usedPercentage;
            document.getElementById('heapMemory').textContent = `${formatBytes(memory.heap.usedBytes)} / ${formatBytes(memory.heap.totalBytes)} (${heapUsedPercentage.toFixed(1)}% used)`;
            
            const heapProgressBar = document.getElementById('heapProgressBar');
            heapProgressBar.style.width = `${heapUsedPercentage}%`;
            heapProgressBar.className = `progress-fill ${getMemoryProgressClass(memory.heap.freePercentage)}`;

            // PSRAM Memory
            const psramUsedPercentage = memory.psram.usedPercentage;
            document.getElementById('psramMemory').textContent = `${formatBytes(memory.psram.usedBytes)} / ${formatBytes(memory.psram.totalBytes)} (${psramUsedPercentage.toFixed(1)}% used)`;
            
            const psramProgressBar = document.getElementById('psramProgressBar');
            psramProgressBar.style.width = `${psramUsedPercentage}%`;
            psramProgressBar.className = `progress-fill ${getMemoryProgressClass(memory.psram.freePercentage)}`;
        }

        function displayStorageInfo(storage) {
            // LittleFS Storage
            const littlefsUsedPercentage = storage.littlefs.usedPercentage;
            document.getElementById('littlefsStorage').textContent = `${formatBytes(storage.littlefs.usedBytes)} / ${formatBytes(storage.littlefs.totalBytes)} (${littlefsUsedPercentage.toFixed(1)}% used)`;
            
            const littlefsProgressBar = document.getElementById('littlefsProgressBar');
            littlefsProgressBar.style.width = `${littlefsUsedPercentage}%`;
            littlefsProgressBar.className = `progress-fill ${getStorageProgressClass(littlefsUsedPercentage)}`;

            // NVS Storage
            const nvsUsedPercentage = storage.nvs.usedEntriesPercentage;
            document.getElementById('nvsStorage').textContent = `${storage.nvs.usedEntries} / ${storage.nvs.totalUsableEntries} entries (${nvsUsedPercentage.toFixed(1)}% used)`;
            
            const nvsProgressBar = document.getElementById('nvsProgressBar');
            nvsProgressBar.style.width = `${nvsUsedPercentage}%`;
            nvsProgressBar.className = `progress-fill ${getStorageProgressClass(nvsUsedPercentage)}`;
        }

        function displayNetworkInfo(network) {
            // WiFi Status
            const wifiStatusElement = document.getElementById('wifiStatus');
            if (network.wifiConnected) {
                wifiStatusElement.textContent = 'Connected';
                wifiStatusElement.className = 'info-value status-indicator status-excellent';
            } else {
                wifiStatusElement.textContent = 'Disconnected';
                wifiStatusElement.className = 'info-value status-indicator status-critical';
            }

            document.getElementById('wifiSsid').textContent = network.wifiSsid || 'N/A';
            document.getElementById('wifiLocalIp').textContent = network.wifiLocalIp || 'N/A';
            
            // WiFi Signal Strength with color coding
            const wifiRssiElement = document.getElementById('wifiRssi');
            if (network.wifiRssi) {
                const signalQuality = getSignalQuality(network.wifiRssi);
                const signalClass = getSignalQualityClass(network.wifiRssi);
                wifiRssiElement.innerHTML = `<span class="status-indicator ${signalClass}">${network.wifiRssi} dBm ${signalQuality}</span>`;
            } else {
                wifiRssiElement.textContent = 'N/A';
            }
            
            document.getElementById('wifiMacAddress').textContent = network.wifiMacAddress || 'N/A';
            document.getElementById('wifiGateway').textContent = network.wifiGatewayIp || 'N/A';
        }

        function displayTaskInfo(tasks) {
            const systemContainer = document.getElementById('systemTaskStackContainer');
            const appContainer = document.getElementById('appTaskStackContainer');
            systemContainer.innerHTML = ''; // Clear existing content
            appContainer.innerHTML = ''; // Clear existing content

            // Filter and sort tasks - only show tasks with allocated stack > 0
            const activeTasks = Object.entries(tasks)
                .filter(([name, task]) => task.allocatedStack > 0)
                .sort((a, b) => b[1].usedPercentage - a[1].usedPercentage); // Sort by usage percentage desc

            // Define which tasks are system vs application
            const systemTasks = ['customWifi', 'customServerHealthCheck', 'customServerOtaTimeout', 
                               'led', 'crashMonitor', 'buttonHandler', 'udpLog', 'maintenance'];
            
            const systemTaskList = activeTasks.filter(([name]) => systemTasks.includes(name));
            const appTaskList = activeTasks.filter(([name]) => !systemTasks.includes(name));

            // Render system tasks
            systemTaskList.forEach(([taskName, taskData], index) => {
                const taskElement = document.createElement('div');
                taskElement.innerHTML = `
                    <div class="info-item">
                        <span class="info-label"><span class="emoji">üîß</span>${getTaskDisplayName(taskName)}</span>
                        <span class="info-value">${formatBytes(taskData.allocatedStack - taskData.minimumFreeStack)} / ${formatBytes(taskData.allocatedStack)} (${taskData.usedPercentage.toFixed(1)}% used)</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill ${getTaskProgressClass(taskData.usedPercentage)}" style="width: ${taskData.usedPercentage}%"></div>
                    </div>
                    ${index < systemTaskList.length - 1 ? '<div style="margin-bottom: 15px;"></div>' : ''}
                `;
                systemContainer.appendChild(taskElement);
            });

            // Render application tasks
            appTaskList.forEach(([taskName, taskData], index) => {
                const taskElement = document.createElement('div');
                taskElement.innerHTML = `
                    <div class="info-item">
                        <span class="info-label"><span class="emoji">‚ö°</span>${getTaskDisplayName(taskName)}</span>
                        <span class="info-value">${formatBytes(taskData.allocatedStack - taskData.minimumFreeStack)} / ${formatBytes(taskData.allocatedStack)} (${taskData.usedPercentage.toFixed(1)}% used)</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill ${getTaskProgressClass(taskData.usedPercentage)}" style="width: ${taskData.usedPercentage}%"></div>
                    </div>
                    ${index < appTaskList.length - 1 ? '<div style="margin-bottom: 15px;"></div>' : ''}
                `;
                appContainer.appendChild(taskElement);
            });
        }

        function getTaskDisplayName(taskName) {
            const taskNames = {
                'mqtt': 'MQTT Client',
                'customMqtt': 'Custom MQTT',
                'customServerHealthCheck': 'Server Health Check',
                'customServerOtaTimeout': 'OTA Timeout',
                'led': 'LED Controller',
                'influxDb': 'InfluxDB Client',
                'crashMonitor': 'Crash Monitor',
                'buttonHandler': 'Button Handler',
                'udpLog': 'UDP Logger',
                'customWifi': 'WiFi Manager',
                'ade7953MeterReading': 'Energy Meter Reading',
                'ade7953EnergySave': 'Energy Data Save',
                'ade7953HourlyCsv': 'Hourly CSV Export',
                'maintenance': 'System Maintenance'
            };
            return taskNames[taskName] || taskName;
        }

        function getTaskProgressClass(usedPercentage) {
            if (usedPercentage < 50) return 'progress-good';
            if (usedPercentage < 75) return 'progress-warning';
            return 'progress-critical';
        }

        function formatUptime(milliseconds) {
            const uptime = milliseconds / 1000;
            const days = Math.floor(uptime / 86400);
            const hours = Math.floor((uptime % 86400) / 3600);
            const minutes = Math.floor((uptime % 3600) / 60);
            const seconds = Math.floor(uptime % 60);

            const parts = [];
            if (days > 0) parts.push(`${days}d`);
            if (hours > 0) parts.push(`${hours}h`);
            if (minutes > 0) parts.push(`${minutes}m`);
            if (seconds > 0) parts.push(`${seconds}s`);

            return parts.length > 0 ? parts.join(' ') : '0s';
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function getMemoryProgressClass(freePercentage) {
            if (freePercentage > 50) return 'progress-good';
            if (freePercentage > 25) return 'progress-warning';
            return 'progress-critical';
        }

        function getStorageProgressClass(usedPercentage) {
            if (usedPercentage < 50) return 'progress-good';
            if (usedPercentage < 75) return 'progress-warning';
            return 'progress-critical';
        }

        function getSignalQuality(rssi) {
            if (rssi > -50) return '(Excellent)';
            if (rssi > -60) return '(Good)';
            if (rssi > -70) return '(Fair)';
            return '(Poor)';
        }

        function getSignalQualityClass(rssi) {
            if (rssi > -50) return 'status-excellent';  // Excellent signal
            if (rssi > -60) return 'status-good';       // Good signal
            if (rssi > -70) return 'status-warning';    // Fair signal
            return 'status-critical';                   // Poor signal
        }

        // Initial load and periodic updates
        document.addEventListener('DOMContentLoaded', function() {
            fetchSystemInfo();
            setInterval(fetchSystemInfo, 5000); // Update every 5 seconds
        });
    </script>
</body>

</html>
