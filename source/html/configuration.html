<!-- SPDX-License-Identifier: GPL-3.0-or-later -->
<!-- Copyright (C) 2025 Jibril Sharafi -->

<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" type="text/css" href="/css/button.css">
    <link rel="stylesheet" type="text/css" href="/css/styles.css">
    <link rel="stylesheet" type="text/css" href="/css/section.css">
    <link rel="stylesheet" type="text/css" href="/css/typography.css">
    <link rel="stylesheet" type="text/css" href="/css/forms.css">

    <link rel="icon" type="image/svg+xml" href="/favicon.svg">

    <title>Configuration</title>
    <style>
        /* Slider-specific styles */
        .slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 15px;
            border-radius: 5px;
            background: linear-gradient(to right, var(--green) 0%, var(--green) calc(var(--slider-value, 50%) - 1.25%), #d3d3d3 calc(var(--slider-value, 50%) + 1.25%), #d3d3d3 100%);
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
        }

        .slider:hover {
            opacity: 1;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: var(--green);
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: var(--green);
            cursor: pointer;
        }
        
        /* Page-specific mobile styles */
        @media screen and (max-width: 768px) {
            .slider {
                height: 20px;
                margin: 10px 0;
            }
            
            .slider::-webkit-slider-thumb {
                width: 30px;
                height: 30px;
            }
            
            .slider::-moz-range-thumb {
                width: 30px;
                height: 30px;
            }
            
            #influxDbStatusContainer {
                flex-direction: column;
                align-items: flex-start;
            }
            
            #influxDbStatusIcon {
                margin-bottom: 8px;
                margin-right: 0;
            }
            
        }
    </style>
</head>

<body>
    <div class="buttonNavigation-container">
        <a class="buttonNavigation" type="home" href="/">üè† Home</a>
        <a class="buttonNavigation" type="inner" href="/calibration">‚öñÔ∏è Calibration</a>
        <a class="buttonNavigation" type="inner" href="/channel">üì∫ Channel</a>
    </div>

    <div class="section-box">
        <h2>Cloud Services</h2>
        <p><i>Cloud services are used to send data to the cloud. This is useful for monitoring the device
                remotely and get the latest firmware updates.</i></p>
        <input type="checkbox" id="cloudServices" class="config-input">
        <label for="cloudServices">Enable cloud services</label>
        <br><br>
        <button class="buttonForm" onclick="setCloudServices()" id="setCloudServicesButton">‚òÅÔ∏è Set cloud services</button>
    </div>

    <div class="section-box">
        <h2>LED Brightness</h2>
        <p><i>LED brightness is used to adjust the brightness of the status LED on the device. Keeping a small
                amount of brightness is recommended.</i></p>
        <input type="range" id="ledBrightness" class="config-input slider" min="0" max="100"
            oninput="updateBrightnessValue()">
        <span id="ledBrightnessValue">50%</span>
        <br><br>
        <button class="buttonForm" onclick="setLedBrightness()" id="setLedBrightnessButton">üí° Set brightness</button>
    </div>

    <div class="section-box">
        <h2>Logging</h2>
        <p><i>Logging is used to record events and errors. It is useful for debugging and troubleshooting.</i></p>
        <div>
            <h3>Print</h3>
            <p><i>Print logging is used to display events and errors when the serial monitor is available. The serial
                    monitor is available when the device is connected to a computer via USB.</i></p>
            <select id="printLogLevel" class="config-input"></select>
        </div>
        <br>
        <div>
            <h3>Save</h3>
            <p><i>Save logging is used to record events and errors to the internal memory of the device. The internal
                    memory is limited, so it is recommended to only use this for troubleshooting.</i></p>
            <select id="saveLogLevel" class="config-input"></select>
        </div>
        <br>
        <button class="buttonForm" onclick="setLogLevel()" id="setLogLevel">üìù Set logging level</button>
        <button class="buttonForm" onclick="clearLogs()" id="clearLogs">üóëÔ∏è Clear log</button>
        <a class="buttonForm" href="/log" id="log" style="float: right;">üìã Explore log</a>
    </div>

    <div class="section-box">
        <h2>Custom MQTT</h2>
        <p><i>
                Custom MQTT is used to send meter data to a custom MQTT server. This is useful for integrating the
                device with your own IoT platform.
                <br>
                <br>
                The payload content will be the same one returned by the REST API endpoint <a href="/api/v1/ade7953/meter-values"
                    target="_blank">meter</a>
                (<a href="/swagger-ui#/ADE7953/get_api_v1_ade7953_meter_values" target="_blank">swagger</a>).
            </i></p>
        <input type="checkbox" id="customMqttEnabled" class="config-input">
        <label for="customMqttEnabled">Enable custom MQTT</label>
        <div id="customMqttSettings">
            <label for="customMqttServer">Server:</label>
            <input type="text" id="customMqttServer" class="config-input" placeholder="e.g., mqtt.example.com">
            <br>
            <label for="customMqttPort">Port:</label>
            <input type="number" id="customMqttPort" class="config-input" placeholder="e.g., 1883">
            <br>
            <label for="customMqttClientId">Client ID:</label>
            <input type="text" id="customMqttClientId" class="config-input" placeholder="e.g., client123">
            <br>
            <label for="customMqttTopic">Topic:</label>
            <input type="text" id="customMqttTopic" class="config-input" placeholder="e.g., home/sensor">
            <br>
            <label for="customMqttFrequency">Frequency (in seconds):</label>
            <input type="number" id="customMqttFrequency" class="config-input" placeholder="e.g., 60" min="1"
                max="86400">
            <br>
            <input type="checkbox" id="customMqttUseCredentials" class="config-input">
            <label for="useCredentials">Use credentials</label>
            <br>
            <label for="customMqttUsername">Username:</label>
            <input type="text" id="customMqttUsername" class="config-input" placeholder="Leave empty if not required">
            <br>
            <label for="customMqttPassword">Password:</label>
            <input type="password" id="customMqttPassword" class="config-input"
                placeholder="Leave empty if not required">
        </div>
        <div id="customMqttStatus"
            style="margin-top: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9;">
            <div id="statusContainer" style="display: flex; align-items: center;">
                <span id="statusIcon" style="font-size: 1.5em; margin-right: 10px;">‚ö™</span>
                <div>
                    <strong>Status: </strong><span id="lastConnectionStatus">Loading...</span><br>
                    <span id="timestampContainer"><strong>Last Attempt: </strong><span
                            id="lastConnectionAttemptTimestamp">Loading...</span></span>
                </div>
            </div>
        </div> <button class="buttonForm" onclick="setCustomMqttConfiguration()"
            id="setCustomMqttConfigurationButton">üíæ Set
            configuration</button>
        <button class="buttonForm" onclick="getCustomMqttConfiguration()" id="reloadCustomMqttButton"
            style="float: right;">üîÑ Reload Status</button>
    </div>

    <div class="section-box">
        <h2>InfluxDB</h2>
        <p><i>
                InfluxDB is used to send meter data to an InfluxDB time-series database. This is useful for storing
                historical data and creating dashboards with tools like Grafana.
                <br>
                <br>
                The data will be sent in InfluxDB Line Protocol format with all meter values as fields.
            </i></p>
        <input type="checkbox" id="influxDbEnabled" class="config-input">
        <label for="influxDbEnabled">Enable InfluxDB</label>
        <div id="influxDbSettings">
            <label for="influxDbServer">Server:</label>
            <input type="text" id="influxDbServer" class="config-input"
                placeholder="e.g., localhost or influxdb.example.com">
            <br>
            <label for="influxDbPort">Port:</label>
            <input type="number" id="influxDbPort" class="config-input" placeholder="e.g., 8086">
            <br>
            <label for="influxDbVersion">Version:</label>
            <select id="influxDbVersion" class="config-input">
                <option value="1">InfluxDB v1.x</option>
                <option value="2">InfluxDB v2.x</option>
            </select>
            <br>
            <input type="checkbox" id="influxDbUseSsl" class="config-input">
            <label for="influxDbUseSsl">Use SSL (HTTPS)</label>
            <br>
            <div id="influxDbV1Settings">
                <h4>InfluxDB v1.x Settings</h4>
                <label for="influxDbDatabase">Database:</label>
                <input type="text" id="influxDbDatabase" class="config-input" placeholder="e.g., energyme-home">
                <br>
                <label for="influxDbUsername">Username:</label>
                <input type="text" id="influxDbUsername" class="config-input" placeholder="Leave empty if not required">
                <br>
                <label for="influxDbPassword">Password:</label>
                <input type="password" id="influxDbPassword" class="config-input"
                    placeholder="Leave empty if not required">
            </div>
            <div id="influxDbV2Settings">
                <h4>InfluxDB v2.x Settings</h4>
                <label for="influxDbOrganization">Organization:</label>
                <input type="text" id="influxDbOrganization" class="config-input" placeholder="e.g., my-org">
                <br>
                <label for="influxDbBucket">Bucket:</label>
                <input type="text" id="influxDbBucket" class="config-input" placeholder="e.g., energyme-home">
                <br>
                <label for="influxDbToken">Token:</label>
                <input type="password" id="influxDbToken" class="config-input" placeholder="API token">
            </div>
            <label for="influxDbMeasurement">Measurement:</label>
            <input type="text" id="influxDbMeasurement" class="config-input" placeholder="e.g., meter">
            <br>
            <label for="influxDbFrequency">Frequency (in seconds):</label>
            <input type="number" id="influxDbFrequency" class="config-input" placeholder="e.g., 30" min="1" max="3600">
        </div>
        <div id="influxDbStatus"
            style="margin-top: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9;">
            <div id="influxDbStatusContainer" style="display: flex; align-items: center;">
                <span id="influxDbStatusIcon" style="font-size: 1.5em; margin-right: 10px;">‚ö™</span>
                <div>
                    <strong>Status: </strong><span id="influxDbLastConnectionStatus">Loading...</span><br>
                    <span id="influxDbTimestampContainer"><strong>Last Attempt: </strong><span
                            id="influxDbLastConnectionAttemptTimestamp">Loading...</span></span>
                </div>
            </div>
        </div> <button class="buttonForm" onclick="setInfluxDbConfiguration()" id="setInfluxDbConfigurationButton">üíæ
            Set
            configuration</button>
        <button class="buttonForm" onclick="getInfluxDbConfiguration()" id="reloadInfluxDbButton"
            style="float: right;">üîÑ Reload Status</button>
    </div>

    <div class="section-box">
        <h2>Change Password</h2>
        <p><i>Change your password to secure your device. Default credentials should be changed immediately after first login.</i></p>
        <div style="display: flex; flex-direction: column; gap: 10px; margin: 15px 0;">
            <div>
                <label for="currentPassword">Current Password:</label>
                <input type="password" id="currentPassword" class="config-input" placeholder="Enter current password" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div>
                <label for="newPassword">New Password:</label>
                <input type="password" id="newPassword" class="config-input" placeholder="Enter new password (min. 8 characters)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div>
                <label for="confirmPassword">Confirm New Password:</label>
                <input type="password" id="confirmPassword" class="config-input" placeholder="Confirm new password" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
        </div>
        <button class="buttonForm" onclick="changePassword()" id="changePasswordButton">üîë Change Password</button>
    </div>

    <div class="section-box">
        <h2>Restart Device</h2>
        <p><i>You already know that restarting a device magically fixes most issues. It will take 10 seconds.</i></p>
        <button class="buttonForm" onclick="restart()" id="restart">üîÑ Restart</button>
    </div>

    <div class="section-box">
        <h2>Sync Time</h2>
        <p><i>Sync the device time with your browser. Useful for devices without internet connectivity (static IP, isolated networks).</i></p>
        <p id="currentDeviceTime">Device time: Loading...</p>
        <button class="buttonForm" onclick="syncTime()" id="syncTime">üïê Sync Time</button>
    </div>

    <div class="section-box">
        <h2>Switch WiFi Network</h2>
        <p><i>Enter new WiFi credentials to switch to a different network. The device will save the credentials and restart to connect to the new network.</i></p>
        <div style="display: flex; flex-direction: column; gap: 10px; margin: 15px 0;">
            <div>
                <label for="newWifiSsid">Network Name (SSID):</label>
                <input type="text" id="newWifiSsid" class="config-input" placeholder="Enter WiFi network name" maxlength="32" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div>
                <label for="newWifiPassword">Password:</label>
                <input type="password" id="newWifiPassword" class="config-input" placeholder="Enter WiFi password" maxlength="63" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
        </div>
        <div class="warning-box"
            style="background-color: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin: 10px 0;"> ‚ö†Ô∏è
            Warning: The device will restart to apply the new credentials. You will temporarily lose access.
        </div>
        <button class="buttonForm" onclick="switchWifi()" id="switchWifi">üì∂ Switch Network</button>
    </div>

    <div class="section-box">
        <h2>Disconnect from WiFi</h2>
        <p><i>This will erase the WiFi credentials.</i></p>
        <p><i>The device will create a WiFi network called "EnergyMe-XXXXXXXXXX" (where XXXXXXXXXX is the device ID) with no password.
                Connect to that network and navigate to <a href="http://192.168.4.1" ,
                    target="_blank">http://192.168.4.1</a>
                (or <a href="http://energyme.local" , target="_blank">http://energyme.local</a>)
                if the device does not redirect you automatically.
                You can then configure the device to connect to your WiFi network.</i></p>
        <div class="warning-box"
            style="background-color: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin: 10px 0;"> ‚ö†Ô∏è
            Warning: You will lose access to the device until you reconnect it to WiFi.
        </div>
        <button class="buttonForm" onclick="disconnectWifi()" id="disconnect">üì∂ Disconnect</button>
    </div>

    <div class="section-box">
        <h2>Factory Reset</h2>
        <p><i>This will reset the device to its factory settings. Useful if you are having issues with the device or
                want to start fresh.</i></p>
        <p><i>WiFi credentials will be kept.</i></p>
        <div class="warning-box"
            style="background-color: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin: 10px 0;"> ‚ö†Ô∏è
            Warning: This will erase all configurations and data. This action cannot be undone.
        </div>
        <button class="buttonForm" onclick="factoryReset()" id="factoryReset">üè≠ Reset</button>
    </div>

    <script src="/js/api-client.js"></script>
    <script>
        var logLevels = ["Verbose", "Debug", "Info", "Warning", "Error", "Fatal"];
        var customMqttConfig;
        var influxDbConfig;

        // Auto-reload intervals
        var customMqttAutoReloadInterval = null;
        var influxDbAutoReloadInterval = null;
        const AUTO_RELOAD_INTERVAL_MS = 5000; // 5 seconds

        function populateDropdown() {
            var printLogLevel = document.getElementById("printLogLevel");
            var saveLogLevel = document.getElementById("saveLogLevel");

            // Clear existing options
            printLogLevel.innerHTML = "";
            saveLogLevel.innerHTML = "";

            for (var i = 0; i < logLevels.length; i++) {
            var opt = document.createElement("option");
            opt.value = logLevels[i];
            opt.innerHTML = logLevels[i];

            printLogLevel.appendChild(opt.cloneNode(true));
            // Exclude "Verbose" from saveLogLevel
            if (logLevels[i] !== "Verbose") {
                saveLogLevel.appendChild(opt.cloneNode(true));
            }
            }
        }

        function restart() {
            var restartButton = document.getElementById("restart");
            restartButton.innerHTML = "Restarting. You will be redirected to the home page in some seconds.";
            restartButton.disabled = true;

            energyApi.restartSystem()
                .then(response => {
                    showStatus('', "Device restarting... You will be redirected in 12 seconds.", 'success', 12000);
                    setTimeout(function () {
                        window.location.href = "/";
                    }, 12000);
                })
                .catch(error => {
                    showStatus('', "Error restarting device: " + error.message, 'error');
                    restartButton.innerHTML = "üîÑ Restart";
                    restartButton.disabled = false;
                });
        }

        function loadDeviceTime() {
            energyApi.getSystemTime()
                .then(response => {
                    const timeEl = document.getElementById("currentDeviceTime");
                    const syncStatus = response.synced ? "‚úÖ Synced" : "‚ö†Ô∏è Not synced";
                    timeEl.innerHTML = `Device time: ${response.isoTime} (${syncStatus})`;
                })
                .catch(error => {
                    document.getElementById("currentDeviceTime").innerHTML = "Device time: Error loading";
                });
        }

        function syncTime() {
            const syncButton = document.getElementById("syncTime");
            syncButton.innerHTML = "Syncing...";
            syncButton.disabled = true;

            const unixSeconds = Math.floor(Date.now() / 1000);

            energyApi.setSystemTime(unixSeconds)
                .then(response => {
                    syncButton.innerHTML = "üïê Sync Time";
                    syncButton.disabled = false;
                    showStatus('syncTimeStatus', 'Time synchronized successfully! New time: ' + response.newTime, 'success');
                    loadDeviceTime();
                })
                .catch(error => {
                    syncButton.innerHTML = "üïê Sync Time";
                    syncButton.disabled = false;
                    showStatus('syncTimeStatus', 'Error syncing time: ' + error.message, 'error');
                });
        }

        // Load device time on page load
        document.addEventListener("DOMContentLoaded", function() {
            loadDeviceTime();
        });
        
        function switchWifi() {
            const ssid = document.getElementById("newWifiSsid").value.trim();
            const password = document.getElementById("newWifiPassword").value;

            if (!ssid) {
                showStatus('', 'Please enter a WiFi network name (SSID).', 'error');
                return;
            }

            var userConfirmed = window.confirm("Are you sure you want to switch to WiFi network '" + ssid + "'? The device will restart to apply the new credentials.");
            if (!userConfirmed) {
                return;
            }

            const button = document.getElementById("switchWifi");
            button.innerHTML = "Switching...";
            button.disabled = true;

            energyApi.setWifiCredentials(ssid, password)
                .then(response => {
                    button.innerHTML = "Credentials saved! Restarting...";
                    showStatus('', "WiFi credentials saved successfully. The device will restart and connect to '" + ssid + "'. Please wait about 15 seconds.", 'success', 8000);
                    // Clear the form
                    document.getElementById("newWifiSsid").value = "";
                    document.getElementById("newWifiPassword").value = "";
                })
                .catch(error => {
                    button.innerHTML = "üì∂ Switch Network";
                    button.disabled = false;
                    showStatus('', "Error switching WiFi network: " + error.message, 'error');
                });
        }

        function disconnectWifi() {
            var confirm = window.confirm("Are you sure you want to disconnect from WiFi? You will lose access to the device until you reconnect it to WiFi.");
            if (!confirm) {
                return;
            }
            document.getElementById("disconnect").innerHTML = "Disconnecting...";
            document.getElementById("disconnect").disabled = true;

            energyApi.resetWifi()
                .then(response => {
                    showStatus('', "Successfully disconnected from WiFi. Please connect to the WiFi network called 'EnergyMe' and navigate to http://192.168.4.1", 'success', 10000);
                    document.getElementById("disconnect").innerHTML = "üì∂ Disconnect";
                    document.getElementById("disconnect").disabled = false;
                })
                .catch(error => {
                    // Treat "signal is aborted without reason" as successful (it means WiFi was reset)
                    if (error.message && error.message.includes("signal is aborted without reason")) {
                        showStatus('', "Successfully disconnected from WiFi. Please connect to the WiFi network called 'EnergyMe' and navigate to http://192.168.4.1", 'success', 10000);
                    } else {
                        showStatus('', "Error disconnecting from WiFi: " + error.message, 'error');
                    }
                    document.getElementById("disconnect").innerHTML = "üì∂ Disconnect";
                    document.getElementById("disconnect").disabled = false;
                });
        } 
        
        function factoryReset() {
            var confirm = window.confirm("Are you sure you want to reset the device to factory settings? All configurations and data will be lost.");
            if (!confirm) {
                return;
            }
            document.getElementById("factoryReset").innerHTML = "Waiting for response...";
            document.getElementById("factoryReset").disabled = true;

            energyApi.factoryReset()
                .then(response => {
                    showStatus('', "Reset successful! You will be redirected to the home page in 15 seconds.", 'success', 15000);
                    document.getElementById("factoryReset").innerHTML = "Reset successful!";
                    setTimeout(function () {
                        window.location.href = "/";
                    }, 15000);
                })
                .catch(error => {
                    showStatus('', "Error resetting to factory settings: " + error.message, 'error');
                    document.getElementById("factoryReset").innerHTML = "üè≠ Reset";
                    document.getElementById("factoryReset").disabled = false;
                });
        } 
        
        function changePassword() {
            const currentPassword = document.getElementById("currentPassword").value;
            const newPassword = document.getElementById("newPassword").value;
            const confirmPassword = document.getElementById("confirmPassword").value;

            // Validation
            if (!currentPassword) {
                showStatus('passwordStatus', 'Please enter your current password.', 'error');
                return;
            }

            if (!newPassword) {
                showStatus('passwordStatus', 'Please enter a new password.', 'error');
                return;
            }

            if (newPassword.length < 8) {
                showStatus('passwordStatus', 'New password must be at least 8 characters long.', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showStatus('passwordStatus', 'New passwords do not match.', 'error');
                return;
            }

            document.getElementById("changePasswordButton").innerHTML = "Changing password...";
            document.getElementById("changePasswordButton").disabled = true;

            energyApi.changePassword(currentPassword, newPassword)
                .then(response => {
                    showStatus('passwordStatus', 'Password changed successfully! Please use your new password on next login.', 'success');
                    // Clear the form
                    document.getElementById("currentPassword").value = "";
                    document.getElementById("newPassword").value = "";
                    document.getElementById("confirmPassword").value = "";
                    document.getElementById("changePasswordButton").innerHTML = "üîë Change Password";
                    document.getElementById("changePasswordButton").disabled = false;
                })
                .catch(error => {
                    showStatus('passwordStatus', 'Error changing password: ' + error.message, 'error');
                    document.getElementById("changePasswordButton").innerHTML = "üîë Change Password";
                    document.getElementById("changePasswordButton").disabled = false;
                });
        }
        
        function setLogLevel() {
            document.getElementById("setLogLevel").innerHTML = "Setting...";
            document.getElementById("setLogLevel").disabled = true;

            var printLogLevel = document.getElementById("printLogLevel").value.toUpperCase();
            var saveLogLevel = document.getElementById("saveLogLevel").value.toUpperCase();

            // API expects string values like "VERBOSE", "DEBUG", etc.
            var validLevels = ["VERBOSE", "DEBUG", "INFO", "WARNING", "ERROR", "FATAL"];

            // Validate that the levels are valid
            if (!validLevels.includes(printLogLevel) || !validLevels.includes(saveLogLevel)) {
                showStatus('loggingStatus', 'Invalid log level selected', 'error');
                document.getElementById("setLogLevel").innerHTML = "üìù Set logging level";
                document.getElementById("setLogLevel").disabled = false;
                return;
            }

            console.log("Setting log levels:", { print: printLogLevel, save: saveLogLevel });

            energyApi.setLogLevels({
                print: printLogLevel,
                save: saveLogLevel
            })
                .then(response => {
                    showStatus('loggingStatus', 'Log level set successfully', 'success');
                    document.getElementById("setLogLevel").innerHTML = "üìù Set logging level";
                    document.getElementById("setLogLevel").disabled = false;
                })
                .catch(error => {
                    showStatus('loggingStatus', 'Error setting log level: ' + error.message, 'error');
                    document.getElementById("setLogLevel").innerHTML = "üìù Set logging level";
                    document.getElementById("setLogLevel").disabled = false;
                });
        }
        
        function getLogLevel() {
            energyApi.getLogLevels()
                .then(data => {
                    // API returns string values like "VERBOSE", "DEBUG", etc.
                    // Convert to dropdown format (first letter uppercase, rest lowercase)
                    function formatLevelForDropdown(level) {
                        if (!level) return "Debug";
                        return level.charAt(0).toUpperCase() + level.slice(1).toLowerCase();
                    }
                    
                    var printLogLevel = formatLevelForDropdown(data.print);
                    var saveLogLevel = formatLevelForDropdown(data.save);

                    populateDropdown();
                    document.getElementById("printLogLevel").value = printLogLevel;
                    document.getElementById("saveLogLevel").value = saveLogLevel;
                })
                .catch(error => {
                    console.log("Error getting log levels. Response: " + error.message);
                });
        } 
        
        function clearLogs() {
            var confirm = window.confirm("Are you sure you want to clear the log?");
            if (!confirm) {
                return;
            }
            document.getElementById("clearLogs").innerHTML = "Clearing...";
            document.getElementById("clearLogs").disabled = true;

            energyApi.clearLogs()
                .then(response => {
                    showStatus('loggingStatus', 'Log cleared successfully', 'success');
                    document.getElementById("clearLogs").innerHTML = "üóëÔ∏è Clear log";
                    document.getElementById("clearLogs").disabled = false;
                })
                .catch(error => {
                    showStatus('loggingStatus', 'Error clearing log: ' + error.message, 'error');
                    document.getElementById("clearLogs").innerHTML = "üóëÔ∏è Clear log";
                    document.getElementById("clearLogs").disabled = false;
                });
        }

        function getCloudServices() {
            energyApi.getMqttCloudServices()
                .then(data => {
                    document.getElementById("cloudServices").checked = data.enabled;
                })
                .catch(error => {
                    console.log("Error getting cloud services status. Response: " + error.message);
                });
        }

        function setCloudServices() {
            document.getElementById("setCloudServicesButton").innerHTML = "Setting...";
            document.getElementById("setCloudServicesButton").disabled = true;

            // First check secrets status
            energyApi.getSystemSecrets()
                .then(secretsResponse => {
                    const isEnabled = document.getElementById("cloudServices").checked;

                    // If no secrets but cloud services is checked, prevent that
                    if (!secretsResponse.hasSecrets && isEnabled) {
                        showStatus('cloudServicesStatus', 'Cannot enable: firmware does not include secrets', 'error');
                        document.getElementById("cloudServices").checked = false;
                        throw new Error("No secrets available");
                    }

                    // Send the configuration
                    return energyApi.setMqttCloudServices(isEnabled);
                })
                .then(data => {
                    showStatus('cloudServicesStatus', 'Cloud services updated', 'success');
                    document.getElementById("setCloudServicesButton").innerHTML = "‚òÅÔ∏è Set cloud services";
                    document.getElementById("setCloudServicesButton").disabled = false;
                })
                .catch(error => {
                    if (error.message !== "No secrets available") {
                        showStatus('cloudServicesStatus', 'Error: ' + error.message, 'error');
                    }
                    document.getElementById("setCloudServicesButton").innerHTML = "‚òÅÔ∏è Set cloud services";
                    document.getElementById("setCloudServicesButton").disabled = false;
                });
        }

        function getLedBrightness() {
            energyApi.getLedBrightness()
                .then(data => {
                    // Assuming API returns brightness as 0-100 range
                    document.getElementById("ledBrightness").value = data.brightness;
                    updateBrightnessValue();
                })
                .catch(error => {
                    console.log("Error getting LED brightness. Response: " + error.message);
                });
        }

        function setLedBrightness() {
            document.getElementById("setLedBrightnessButton").innerHTML = "Setting...";
            document.getElementById("setLedBrightnessButton").disabled = true;

            const brightness = parseInt(document.getElementById("ledBrightness").value);

            energyApi.setLedBrightness(brightness)
                .then(data => {
                    showStatus('ledBrightnessStatus', 'Brightness set successfully', 'success');
                    document.getElementById("setLedBrightnessButton").innerHTML = "üí° Set brightness";
                    document.getElementById("setLedBrightnessButton").disabled = false;
                })
                .catch(error => {
                    showStatus('ledBrightnessStatus', 'Error: ' + error.message, 'error');
                    document.getElementById("setLedBrightnessButton").innerHTML = "üí° Set brightness";
                    document.getElementById("setLedBrightnessButton").disabled = false;
                });
        }

        function updateBrightnessValue() {
            var slider = document.getElementById("ledBrightness");
            var output = document.getElementById("ledBrightnessValue");
            var percentage = parseInt(slider.value);
            slider.style.setProperty('--slider-value', percentage + '%');
            slider.title = percentage + "%";
            output.innerHTML = percentage + "%";
        }

        function getCustomMqttConfiguration() {
            // Load configuration
            energyApi.getCustomMqttConfig()
                .then(data => {
                    customMqttConfig = data;

                    document.getElementById("customMqttEnabled").checked = customMqttConfig.enabled;
                    document.getElementById("customMqttServer").value = customMqttConfig.server;
                    document.getElementById("customMqttPort").value = customMqttConfig.port;
                    document.getElementById("customMqttClientId").value = customMqttConfig.clientid;
                    document.getElementById("customMqttTopic").value = customMqttConfig.topic;
                    document.getElementById("customMqttFrequency").value = customMqttConfig.frequency;
                    document.getElementById("customMqttUseCredentials").checked = customMqttConfig.useCredentials;
                    document.getElementById("customMqttUsername").value = customMqttConfig.username;
                    document.getElementById("customMqttPassword").value = customMqttConfig.password;

                    // Load status separately
                    loadCustomMqttStatus();

                    // Start or stop auto-reload based on enabled status
                    if (customMqttConfig.enabled) {
                        startCustomMqttAutoReload();
                    } else {
                        stopCustomMqttAutoReload();
                    }
                })
                .catch(error => {
                    console.log("Error getting custom MQTT configuration. Response: " + error.message);
                    updateStatusDisplay("Error loading configuration", "", false);
                    stopCustomMqttAutoReload();
                });
        }

        function loadCustomMqttStatus() {
            energyApi.get('custom-mqtt/status')
                .then(data => {
                    // Update status display with the latest status information
                    updateStatusDisplay(data.status, data.statusTimestamp, customMqttConfig.enabled);
                })
                .catch(error => {
                    console.log("Error getting custom MQTT status. Response: " + error.message);
                    updateStatusDisplay("Error loading status", "", false);
                });
        }

        function startCustomMqttAutoReload() {
            if (customMqttAutoReloadInterval) {
                clearInterval(customMqttAutoReloadInterval);
            }
            customMqttAutoReloadInterval = setInterval(() => {
                if (customMqttConfig && customMqttConfig.enabled) {
                    loadCustomMqttStatus();
                }
            }, AUTO_RELOAD_INTERVAL_MS);
        }

        function stopCustomMqttAutoReload() {
            if (customMqttAutoReloadInterval) {
                clearInterval(customMqttAutoReloadInterval);
                customMqttAutoReloadInterval = null;
            }
        }

        function updateStatusDisplay(status, timestamp, isEnabled) {
            const statusElement = document.getElementById("lastConnectionStatus");
            const timestampElement = document.getElementById("lastConnectionAttemptTimestamp");
            const timestampContainer = document.getElementById("timestampContainer");
            const statusIcon = document.getElementById("statusIcon");
            const statusContainer = document.getElementById("statusContainer");

            // Reset styles
            statusContainer.style.color = "";
            statusElement.style.fontWeight = "";

            // If MQTT is disabled, show disabled status
            if (!isEnabled) {
                statusElement.textContent = "Disabled";
                timestampContainer.style.display = "none";
                statusIcon.innerHTML = "‚ö´"; // Black circle for disabled
                statusElement.style.color = "#757575"; // Gray color
                return;
            }

            // If enabled, proceed with normal status display
            statusElement.textContent = status || "N/A";
            timestampElement.textContent = timestamp || "N/A";

            // Show/hide timestamp based on connection status
            if (status === "Connected") {
                timestampContainer.style.display = "none";
                statusIcon.innerHTML = "üü¢"; // Green circle for connected
                statusElement.style.color = "#2e7d32"; // Dark green
                statusElement.style.fontWeight = "bold";
            } else if (status === "Disconnected") {
                timestampContainer.style.display = "block";
                statusIcon.innerHTML = "üî¥"; // Red circle for disconnected
                statusElement.style.color = "#c62828"; // Dark red
            } else if (status && status.startsWith("Error")) {
                timestampContainer.style.display = "block";
                statusIcon.innerHTML = "‚ö†Ô∏è"; // Warning for errors
                statusElement.style.color = "#e65100"; // Orange
            } else {
                timestampContainer.style.display = "block";
                statusIcon.innerHTML = "‚ö™"; // Default neutral circle
            }
        }

        function setCustomMqttConfiguration() {
            document.getElementById("setCustomMqttConfigurationButton").innerHTML = "Setting...";
            document.getElementById("setCustomMqttConfigurationButton").disabled = true;

            var currentStatus = customMqttConfig ? customMqttConfig.lastConnectionStatus : "Unknown";
            var currentTimestamp = customMqttConfig ? customMqttConfig.lastConnectionAttemptTimestamp : "";

            var newCustomMqttConfig = {
                "enabled": document.getElementById("customMqttEnabled").checked,
                "server": document.getElementById("customMqttServer").value,
                "port": parseInt(document.getElementById("customMqttPort").value),
                "clientid": document.getElementById("customMqttClientId").value,
                "topic": document.getElementById("customMqttTopic").value,
                "frequency": parseInt(document.getElementById("customMqttFrequency").value),
                "useCredentials": document.getElementById("customMqttUseCredentials").checked,
                "username": document.getElementById("customMqttUsername").value,
                "password": document.getElementById("customMqttPassword").value,
                "lastConnectionStatus": currentStatus,
                "lastConnectionAttemptTimestamp": currentTimestamp
            };

            energyApi.setCustomMqttConfig(newCustomMqttConfig)
                .then(data => {
                    showStatus('mqttConfigStatus', 'MQTT configuration saved', 'success');
                    setTimeout(() => {
                        getCustomMqttConfiguration(); // This will reload config and restart auto-reload if needed
                    }, 2000); // Wait 2 seconds for the device to process the new config
                    document.getElementById("setCustomMqttConfigurationButton").innerHTML = "üíæ Set configuration";
                    document.getElementById("setCustomMqttConfigurationButton").disabled = false;
                })
                .catch(error => {
                    showStatus('mqttConfigStatus', 'Error: ' + error.message, 'error');
                    document.getElementById("setCustomMqttConfigurationButton").innerHTML = "üíæ Set configuration";
                    document.getElementById("setCustomMqttConfigurationButton").disabled = false;
                });

            // Call to refresh the custom MQTT configuration after setting it
            setTimeout(getCustomMqttConfiguration, 1000);
        }

        function checkHasSecrets() {
            energyApi.getSystemSecrets()
                .then(response => {
                    // If no secrets available, disable cloud services option
                    if (!response.hasSecrets) {
                        var cloudServicesCheckbox = document.getElementById("cloudServices");
                        cloudServicesCheckbox.disabled = true;
                        cloudServicesCheckbox.checked = false;

                        // Create warning message if it doesn't exist
                        if (!document.getElementById("cloud-services-warning")) {
                            var warningDiv = document.createElement("div");
                            warningDiv.id = "cloud-services-warning";
                            warningDiv.className = "warning-box";
                            warningDiv.style.backgroundColor = "#fff3cd";
                            warningDiv.style.color = "#856404";
                            warningDiv.style.padding = "10px";
                            warningDiv.style.borderRadius = "5px";
                            warningDiv.style.marginTop = "10px";
                            warningDiv.innerHTML = "‚ö†Ô∏è Cloud services require secrets to be included in the firmware. This build doesn't include secrets.";

                            // Insert after the cloud services label
                            var labelElement = document.querySelector("label[for='cloudServices']");
                            labelElement.parentNode.insertBefore(warningDiv, labelElement.nextSibling);
                        }
                    }
                })
                .catch(error => {
                    console.log("Error checking secrets status:", error.message);
                });
        }

        function updateInfluxDbStatusDisplay(status, timestamp, isEnabled) {
            const statusElement = document.getElementById("influxDbLastConnectionStatus");
            const timestampElement = document.getElementById("influxDbLastConnectionAttemptTimestamp");
            const timestampContainer = document.getElementById("influxDbTimestampContainer");
            const statusIcon = document.getElementById("influxDbStatusIcon");
            const statusContainer = document.getElementById("influxDbStatusContainer");

            // Reset styles
            statusContainer.style.color = "";
            statusElement.style.fontWeight = "";

            // If InfluxDB is disabled, show disabled status
            if (!isEnabled) {
                statusElement.textContent = "Disabled";
                timestampContainer.style.display = "none";
                statusIcon.innerHTML = "‚ö´"; // Black circle for disabled
                statusElement.style.color = "#757575"; // Gray color
                return;
            }

            // If enabled, proceed with normal status display
            statusElement.textContent = status || "N/A";
            timestampElement.textContent = timestamp || "N/A";

            // Show/hide timestamp based on connection status
            if (status === "Upload successful" || status === "Connection successful" || status === "Credentials valid" || status == "Data sent successfully") {
                timestampContainer.style.display = "none"; // Hide timestamp for successful connections
                statusIcon.innerHTML = "üü¢"; // Green circle for successful
                statusElement.style.color = "#2e7d32"; // Dark green
                statusElement.style.fontWeight = "bold";
            } else if (status && status.toLowerCase().includes("failed")) {
                timestampContainer.style.display = "block";
                statusIcon.innerHTML = "üî¥"; // Red circle for failed
                statusElement.style.color = "#c62828"; // Dark red
            } else if (status && status.includes("Error")) {
                timestampContainer.style.display = "block";
                statusIcon.innerHTML = "‚ö†Ô∏è"; // Warning for errors
                statusElement.style.color = "#e65100"; // Orange
            } else {
                timestampContainer.style.display = "block";
                statusIcon.innerHTML = "‚ö™"; // Default neutral circle
            }
        }

        function toggleInfluxDbVersionSettings() {
            const version = document.getElementById("influxDbVersion").value;
            const v1Settings = document.getElementById("influxDbV1Settings");
            const v2Settings = document.getElementById("influxDbV2Settings");

            if (version === "1") {
                v1Settings.style.display = "block";
                v2Settings.style.display = "none";
            } else {
                v1Settings.style.display = "none";
                v2Settings.style.display = "block";
            }
        }

        function getInfluxDbConfiguration() {
            energyApi.getInfluxDbConfig()
                .then(data => {
                    influxDbConfig = data;

                    document.getElementById("influxDbEnabled").checked = influxDbConfig.enabled;
                    document.getElementById("influxDbServer").value = influxDbConfig.server;
                    document.getElementById("influxDbPort").value = influxDbConfig.port;
                    document.getElementById("influxDbVersion").value = influxDbConfig.version;
                    document.getElementById("influxDbDatabase").value = influxDbConfig.database;
                    document.getElementById("influxDbUsername").value = influxDbConfig.username;
                    document.getElementById("influxDbPassword").value = influxDbConfig.password;
                    document.getElementById("influxDbOrganization").value = influxDbConfig.organization;
                    document.getElementById("influxDbBucket").value = influxDbConfig.bucket;
                    document.getElementById("influxDbToken").value = influxDbConfig.token;
                    document.getElementById("influxDbMeasurement").value = influxDbConfig.measurement;
                    document.getElementById("influxDbFrequency").value = influxDbConfig.frequency;
                    document.getElementById("influxDbUseSsl").checked = influxDbConfig.useSsl;

                    toggleInfluxDbVersionSettings();

                    // Load status separately
                    loadInfluxDbStatus();

                    // Start or stop auto-reload based on enabled status
                    if (influxDbConfig.enabled) {
                        startInfluxDbAutoReload();
                    } else {
                        stopInfluxDbAutoReload();
                    }
                })
                .catch(error => {
                    console.log("Error getting InfluxDB configuration. Response: " + error.message);
                    updateInfluxDbStatusDisplay("Error loading configuration", "", false);
                    stopInfluxDbAutoReload();
                });
        }

        function loadInfluxDbStatus() {
            energyApi.get('influxdb/status')
                .then(data => {
                    // Update status display with the latest status information
                    updateInfluxDbStatusDisplay(data.status, data.statusTimestamp, influxDbConfig.enabled);
                })
                .catch(error => {
                    console.log("Error getting InfluxDB status. Response: " + error.message);
                    updateInfluxDbStatusDisplay("Error loading status", "", false);
                });
        }

        function startInfluxDbAutoReload() {
            if (influxDbAutoReloadInterval) {
                clearInterval(influxDbAutoReloadInterval);
            }
            influxDbAutoReloadInterval = setInterval(() => {
                if (influxDbConfig && influxDbConfig.enabled) {
                    loadInfluxDbStatus();
                }
            }, AUTO_RELOAD_INTERVAL_MS);
        }

        function stopInfluxDbAutoReload() {
            if (influxDbAutoReloadInterval) {
                clearInterval(influxDbAutoReloadInterval);
                influxDbAutoReloadInterval = null;
            }
        }

        function setInfluxDbConfiguration() {
            document.getElementById("setInfluxDbConfigurationButton").innerHTML = "Setting...";
            document.getElementById("setInfluxDbConfigurationButton").disabled = true;

            var currentStatus = influxDbConfig ? influxDbConfig.lastConnectionStatus : "Unknown";
            var currentTimestamp = influxDbConfig ? influxDbConfig.lastConnectionAttemptTimestamp : "";

            var newInfluxDbConfig = {
                "enabled": document.getElementById("influxDbEnabled").checked,
                "server": document.getElementById("influxDbServer").value,
                "port": parseInt(document.getElementById("influxDbPort").value),
                "version": parseInt(document.getElementById("influxDbVersion").value),
                "database": document.getElementById("influxDbDatabase").value,
                "username": document.getElementById("influxDbUsername").value,
                "password": document.getElementById("influxDbPassword").value,
                "organization": document.getElementById("influxDbOrganization").value,
                "bucket": document.getElementById("influxDbBucket").value,
                "token": document.getElementById("influxDbToken").value,
                "measurement": document.getElementById("influxDbMeasurement").value,
                "frequency": Math.max(1, Math.min(3600, parseInt(document.getElementById("influxDbFrequency").value))),
                "useSsl": document.getElementById("influxDbUseSsl").checked,
                "lastConnectionStatus": currentStatus,
                "lastConnectionAttemptTimestamp": currentTimestamp
            };

            energyApi.setInfluxDbConfig(newInfluxDbConfig)
                .then(data => {
                    showStatus('influxDbConfigStatus', 'InfluxDB configuration saved', 'success');
                    setTimeout(() => {
                        getInfluxDbConfiguration(); // This will reload config and restart auto-reload if needed
                    }, 2000); // Wait 2 seconds for the device to process the new config
                    document.getElementById("setInfluxDbConfigurationButton").innerHTML = "üíæ Set configuration";
                    document.getElementById("setInfluxDbConfigurationButton").disabled = false;
                })
                .catch(error => {
                    showStatus('influxDbConfigStatus', 'Error: ' + error.message, 'error');
                    document.getElementById("setInfluxDbConfigurationButton").innerHTML = "üíæ Set configuration";
                    document.getElementById("setInfluxDbConfigurationButton").disabled = false;
                });

            // Call to refresh the InfluxDB configuration after setting it
            setTimeout(getInfluxDbConfiguration, 1000);
        }

        // Sequential API loading to prevent overwhelming the ESP32
        async function loadConfigurationData() {
            const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
            const DELAY_BETWEEN_REQUESTS = 100;
            
            try {
                console.log("Loading configuration data sequentially...");
                
                await getCloudServices();
                await delay(DELAY_BETWEEN_REQUESTS);
                
                await getLedBrightness();
                await delay(DELAY_BETWEEN_REQUESTS);
                
                await getLogLevel();
                await delay(DELAY_BETWEEN_REQUESTS);
                
                await getCustomMqttConfiguration();
                await delay(DELAY_BETWEEN_REQUESTS);
                
                await getInfluxDbConfiguration();
                await delay(DELAY_BETWEEN_REQUESTS);
                
                await checkHasSecrets();

                console.log("Configuration data loaded successfully");
                
            } catch (error) {
                console.error("Error loading configuration data:", error);
                showStatus('', 'Error loading configuration data. Please refresh the page.', 'error', 10000);
            }
        }

        // Cleanup function to stop all auto-reload intervals
        function stopAllAutoReload() {
            stopCustomMqttAutoReload();
            stopInfluxDbAutoReload();
        }

        // Stop auto-reload when page is unloaded
        window.addEventListener('beforeunload', stopAllAutoReload);

        document.addEventListener("DOMContentLoaded", function () {
            // Load configuration data sequentially to prevent ESP32 overload
            loadConfigurationData();

            // Add event listener for version change
            document.getElementById("influxDbVersion").addEventListener("change", toggleInfluxDbVersionSettings);
        });

    </script>

</body>

</html>