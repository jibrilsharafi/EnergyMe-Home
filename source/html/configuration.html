<!-- SPDX-License-Identifier: GPL-3.0-or-later -->
<!-- Copyright (C) 2025 Jibril Sharafi -->

<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" type="text/css" href="/css/button.css">
    <link rel="stylesheet" type="text/css" href="/css/styles.css">
    <link rel="stylesheet" type="text/css" href="/css/section.css">
    <link rel="stylesheet" type="text/css" href="/css/typography.css">
    <link rel="stylesheet" type="text/css" href="/css/forms.css">

    <link rel="icon" type="image/svg+xml" href="/favicon.svg">

    <title>Configuration</title>
    <style>
        /* Slider-specific styles */
        .slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 15px;
            border-radius: 5px;
            background: linear-gradient(to right, var(--green) 0%, var(--green) calc(var(--slider-value, 50%) - 1.25%), #d3d3d3 calc(var(--slider-value, 50%) + 1.25%), #d3d3d3 100%);
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
        }

        .slider:hover {
            opacity: 1;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: var(--green);
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: var(--green);
            cursor: pointer;
        }
        
        /* Page-specific mobile styles */
        @media screen and (max-width: 768px) {
            .slider {
                height: 20px;
                margin: 10px 0;
            }
            
            .slider::-webkit-slider-thumb {
                width: 30px;
                height: 30px;
            }

            .slider::-moz-range-thumb {
                width: 30px;
                height: 30px;
            }

        }
    </style>
</head>

<body>
    <div class="buttonNavigation-container">
        <a class="buttonNavigation" type="home" href="/">üè† Home</a>
        <a class="buttonNavigation" type="inner" href="/calibration">‚öñÔ∏è Calibration</a>
        <a class="buttonNavigation" type="inner" href="/channel">üì∫ Channel</a>
    </div>
    
    <div class="section-box">
        <h2>Cloud Services</h2>
        <p><i>Cloud services are used to send data to the cloud. This is useful for monitoring the device
                remotely and get the latest firmware updates.</i></p>
        <input type="checkbox" id="cloudServices" class="config-input">
        <label for="cloudServices">Enable cloud services</label>
        <br><br>
        <button class="buttonForm" onclick="setCloudServices()" id="setCloudServicesButton">‚òÅÔ∏è Set cloud services</button>
    </div>

    <div class="section-box">
        <h2>LED Brightness</h2>
        <p><i>LED brightness is used to adjust the brightness of the status LED on the device. Keeping a small
                amount of brightness is recommended.</i></p>
        <input type="range" id="ledBrightness" class="config-input slider" min="0" max="100"
            oninput="updateBrightnessValue()">
        <span id="ledBrightnessValue">50%</span>
        <br><br>
        <button class="buttonForm" onclick="setLedBrightness()" id="setLedBrightnessButton">üí° Set brightness</button>
    </div>

    <div class="section-box">
        <h2>Logging</h2>
        <p><i>Logging is used to record events and errors. It is useful for debugging and troubleshooting.</i></p>
        <div>
            <h3>Print</h3>
            <p><i>Print logging is used to display events and errors when the serial monitor is available. The serial
                    monitor is available when the device is connected to a computer via USB.</i></p>
            <select id="printLogLevel" class="config-input"></select>
        </div>
        <br>
        <div>
            <h3>Save</h3>
            <p><i>Save logging is used to record events and errors to the internal memory of the device. The internal
                    memory is limited, so it is recommended to only use this for troubleshooting.</i></p>
            <select id="saveLogLevel" class="config-input"></select>
        </div>
        <br>
        <button class="buttonForm" onclick="setLogLevel()" id="setLogLevel">üìù Set logging level</button>
        <button class="buttonForm" onclick="clearLogs()" id="clearLogs">üóëÔ∏è Clear log</button>
        <a class="buttonForm" href="/log" id="log" style="float: right;">üìã Explore log</a>
    </div>

    <div class="section-box">
        <h2>Sync Time</h2>
        <p><i>Sync the device time with your browser. Useful for devices without internet connectivity (static IP, isolated networks).</i></p>
        <p id="currentDeviceTime">Device time: Loading...</p>
        <button class="buttonForm" onclick="syncTime()" id="syncTime">üïê Sync Time</button>
    </div>

    <div class="section-box">
        <h2>Change Password</h2>
        <p><i>Change your password to secure your device. Default credentials should be changed immediately after first login.</i></p>
        <div style="display: flex; flex-direction: column; gap: 10px; margin: 15px 0;">
            <div>
                <label for="currentPassword">Current Password:</label>
                <input type="password" id="currentPassword" class="config-input" placeholder="Enter current password" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div>
                <label for="newPassword">New Password:</label>
                <input type="password" id="newPassword" class="config-input" placeholder="Enter new password (min. 8 characters)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div>
                <label for="confirmPassword">Confirm New Password:</label>
                <input type="password" id="confirmPassword" class="config-input" placeholder="Confirm new password" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
        </div>
        <button class="buttonForm" onclick="changePassword()" id="changePasswordButton">üîë Change Password</button>
    </div>

    <div class="section-box">
        <h2>Restart Device</h2>
        <p><i>You already know that restarting a device magically fixes most issues. It will take 10 seconds.</i></p>
        <button class="buttonForm" onclick="restart()" id="restart">üîÑ Restart</button>
    </div>

    <div class="section-box">
        <h2>Switch WiFi Network</h2>
        <p><i>Enter new WiFi credentials to switch to a different network. The device will save the credentials and restart to connect to the new network.</i></p>
        <div style="display: flex; flex-direction: column; gap: 10px; margin: 15px 0;">
            <div>
                <label for="newWifiSsid">Network Name (SSID):</label>
                <input type="text" id="newWifiSsid" class="config-input" placeholder="Enter WiFi network name" maxlength="32" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div>
                <label for="newWifiPassword">Password:</label>
                <input type="password" id="newWifiPassword" class="config-input" placeholder="Enter WiFi password" maxlength="63" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
        </div>
        <div class="warning-box"
            style="background-color: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin: 10px 0;"> ‚ö†Ô∏è
            Warning: The device will restart to apply the new credentials. You will temporarily lose access.
        </div>
        <button class="buttonForm" onclick="switchWifi()" id="switchWifi">üì∂ Switch Network</button>
    </div>

    <div class="section-box">
        <h2>Disconnect from WiFi</h2>
        <p><i>This will erase the WiFi credentials.</i></p>
        <p><i>The device will create a WiFi network called "EnergyMe-XXXXXXXXXX" (where XXXXXXXXXX is the device ID) with no password.
                Connect to that network and navigate to <a href="http://192.168.4.1" ,
                    target="_blank">http://192.168.4.1</a>
                (or <a href="http://energyme.local" , target="_blank">http://energyme.local</a>)
                if the device does not redirect you automatically.
                You can then configure the device to connect to your WiFi network.</i></p>
        <div class="warning-box"
            style="background-color: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin: 10px 0;"> ‚ö†Ô∏è
            Warning: You will lose access to the device until you reconnect it to WiFi.
        </div>
        <button class="buttonForm" onclick="disconnectWifi()" id="disconnect">üì∂ Disconnect</button>
    </div>

    <div class="section-box">
        <h2>Factory Reset</h2>
        <p><i>This will reset the device to its factory settings. Useful if you are having issues with the device or
                want to start fresh.</i></p>
        <p><i>WiFi credentials will be kept.</i></p>
        <div class="warning-box"
            style="background-color: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin: 10px 0;"> ‚ö†Ô∏è
            Warning: This will erase all configurations and data. This action cannot be undone.
        </div>
        <button class="buttonForm" onclick="factoryReset()" id="factoryReset">üè≠ Reset</button>
    </div>

    <script src="/js/api-client.js"></script>
    <script>
        var logLevels = ["Verbose", "Debug", "Info", "Warning", "Error", "Fatal"];

        function populateDropdown() {
            var printLogLevel = document.getElementById("printLogLevel");
            var saveLogLevel = document.getElementById("saveLogLevel");

            // Clear existing options
            printLogLevel.innerHTML = "";
            saveLogLevel.innerHTML = "";

            for (var i = 0; i < logLevels.length; i++) {
            var opt = document.createElement("option");
            opt.value = logLevels[i];
            opt.innerHTML = logLevels[i];

            printLogLevel.appendChild(opt.cloneNode(true));
            // Exclude "Verbose" from saveLogLevel
            if (logLevels[i] !== "Verbose") {
                saveLogLevel.appendChild(opt.cloneNode(true));
            }
            }
        }

        async function restart() {
            const restartButton = document.getElementById("restart");
            restartButton.disabled = true;
            restartButton.classList.add('loading');

            try {
                showStatus("Restarting device...", 'info');

                await energyApi.restartSystem();

                showStatus("Device restarting... You will be redirected in 12 seconds.", 'success', 12000);
                setTimeout(function () {
                    window.location.href = "/";
                }, 12000);
            } catch (error) {
                showStatus("Error restarting device: " + error.message, 'error');
                restartButton.disabled = false;
                restartButton.classList.remove('loading');
            }
        }

        function loadDeviceTime() {
            energyApi.getSystemTime()
            .then(response => {
                const timeEl = document.getElementById("currentDeviceTime");
                const syncStatus = response.synced ? "‚úÖ Synced" : "‚ö†Ô∏è Not synced";
                timeEl.innerHTML = `Device time: <i>${response.isoTime}</i> (${syncStatus})`;
            })
            .catch(error => {
                document.getElementById("currentDeviceTime").innerHTML = "Device time: Error loading";
            });
        }

        async function syncTime() {
            const syncButton = document.getElementById("syncTime");
            syncButton.disabled = true;
            syncButton.classList.add('loading');

            try {
                showStatus('Syncing time...', 'info');

                const unixSeconds = Math.floor(Date.now() / 1000);
                const response = await energyApi.setSystemTime(unixSeconds);

                showStatus('Time synchronized successfully! New time: ' + response.newTime, 'success');
                loadDeviceTime();
            } catch (error) {
                showStatus('Error syncing time: ' + error.message, 'error');
            } finally {
                syncButton.disabled = false;
                syncButton.classList.remove('loading');
            }
        }

        // Load device time on page load
        document.addEventListener("DOMContentLoaded", function() {
            loadDeviceTime();
        });
        
        async function switchWifi() {
            const ssid = document.getElementById("newWifiSsid").value.trim();
            const password = document.getElementById("newWifiPassword").value;

            if (!ssid) {
                showStatus('Please enter a WiFi network name (SSID).', 'error');
                return;
            }

            const userConfirmed = window.confirm("Are you sure you want to switch to WiFi network '" + ssid + "'? The device will restart to apply the new credentials.");
            if (!userConfirmed) {
                return;
            }

            const button = document.getElementById("switchWifi");
            button.disabled = true;
            button.classList.add('loading');

            try {
                showStatus("Switching WiFi network...", 'info');

                await energyApi.setWifiCredentials(ssid, password);

                showStatus("WiFi credentials saved successfully. The device will restart and connect to '" + ssid + "'. Please wait about 15 seconds.", 'success', 15000);
                // Clear the form
                document.getElementById("newWifiSsid").value = "";
                document.getElementById("newWifiPassword").value = "";
                // Don't restore button - page will become unreachable after restart
            } catch (error) {
                button.disabled = false;
                button.classList.remove('loading');
                showStatus("Error switching WiFi network: " + error.message, 'error');
            }
        }

        async function disconnectWifi() {
            const confirm = window.confirm("Are you sure you want to disconnect from WiFi? You will lose access to the device until you reconnect it to WiFi.");
            if (!confirm) {
                return;
            }

            const button = document.getElementById("disconnect");
            button.disabled = true;
            button.classList.add('loading');

            try {
                showStatus("Disconnecting from WiFi...", 'info');

                await energyApi.resetWifi();

                showStatus("Successfully disconnected from WiFi. Please connect to the WiFi network called 'EnergyMe' and navigate to http://192.168.4.1", 'success', 10000);
            } catch (error) {
                // Treat "signal is aborted without reason" as successful (it means WiFi was reset)
                if (error.message && error.message.includes("signal is aborted without reason")) {
                    showStatus("Successfully disconnected from WiFi. Please connect to the WiFi network called 'EnergyMe' and navigate to http://192.168.4.1", 'success', 10000);
                } else {
                    showStatus("Error disconnecting from WiFi: " + error.message, 'error');
                }
            } finally {
                button.disabled = false;
                button.classList.remove('loading');
            }
        } 
        
        async function factoryReset() {
            const confirm = window.confirm("Are you sure you want to reset the device to factory settings? All configurations and data will be lost.");
            if (!confirm) {
                return;
            }

            const button = document.getElementById("factoryReset");
            button.disabled = true;
            button.classList.add('loading');

            try {
                showStatus("Resetting to factory settings...", 'info');

                await energyApi.factoryReset();

                showStatus("Reset successful! You will be redirected to the home page in 15 seconds.", 'success', 15000);
                setTimeout(function () {
                    window.location.href = "/";
                }, 15000);
            } catch (error) {
                showStatus("Error resetting to factory settings: " + error.message, 'error');
                button.disabled = false;
                button.classList.remove('loading');
            }
        } 
        
        async function changePassword() {
            const currentPassword = document.getElementById("currentPassword").value;
            const newPassword = document.getElementById("newPassword").value;
            const confirmPassword = document.getElementById("confirmPassword").value;

            // Validation
            if (!currentPassword) {
                showStatus('Please enter your current password.', 'error');
                return;
            }

            if (!newPassword) {
                showStatus('Please enter a new password.', 'error');
                return;
            }

            if (newPassword.length < 8) {
                showStatus('New password must be at least 8 characters long.', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showStatus('New passwords do not match.', 'error');
                return;
            }

            const button = document.getElementById("changePasswordButton");
            button.disabled = true;
            button.classList.add('loading');

            try {
                showStatus('Changing password...', 'info');

                await energyApi.changePassword(currentPassword, newPassword);

                showStatus('Password changed successfully! Please use your new password on next login.', 'success');
                // Clear the form
                document.getElementById("currentPassword").value = "";
                document.getElementById("newPassword").value = "";
                document.getElementById("confirmPassword").value = "";
            } catch (error) {
                showStatus('Error changing password: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.classList.remove('loading');
            }
        }
        
        async function setLogLevel() {
            const button = document.getElementById("setLogLevel");
            button.disabled = true;
            button.classList.add('loading');

            try {
                const printLogLevel = document.getElementById("printLogLevel").value.toUpperCase();
                const saveLogLevel = document.getElementById("saveLogLevel").value.toUpperCase();

                // API expects string values like "VERBOSE", "DEBUG", etc.
                const validLevels = ["VERBOSE", "DEBUG", "INFO", "WARNING", "ERROR", "FATAL"];

                // Validate that the levels are valid
                if (!validLevels.includes(printLogLevel) || !validLevels.includes(saveLogLevel)) {
                    showStatus('Invalid log level selected', 'error');
                    button.disabled = false;
                    button.classList.remove('loading');
                    return;
                }

                console.log("Setting log levels:", { print: printLogLevel, save: saveLogLevel });

                showStatus('Setting log level...', 'info');

                await energyApi.setLogLevels({
                    print: printLogLevel,
                    save: saveLogLevel
                });

                showStatus('Log level set successfully', 'success');
            } catch (error) {
                showStatus('Error setting log level: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.classList.remove('loading');
            }
        }
        
        function getLogLevel() {
            energyApi.getLogLevels()
                .then(data => {
                    // API returns string values like "VERBOSE", "DEBUG", etc.
                    // Convert to dropdown format (first letter uppercase, rest lowercase)
                    function formatLevelForDropdown(level) {
                        if (!level) return "Debug";
                        return level.charAt(0).toUpperCase() + level.slice(1).toLowerCase();
                    }
                    
                    var printLogLevel = formatLevelForDropdown(data.print);
                    var saveLogLevel = formatLevelForDropdown(data.save);

                    populateDropdown();
                    document.getElementById("printLogLevel").value = printLogLevel;
                    document.getElementById("saveLogLevel").value = saveLogLevel;
                })
                .catch(error => {
                    console.log("Error getting log levels. Response: " + error.message);
                });
        } 
        
        async function clearLogs() {
            const confirm = window.confirm("Are you sure you want to clear the log?");
            if (!confirm) {
                return;
            }

            const button = document.getElementById("clearLogs");
            button.disabled = true;
            button.classList.add('loading');

            try {
                showStatus('Clearing logs...', 'info');

                await energyApi.clearLogs();

                showStatus('Log cleared successfully', 'success');
            } catch (error) {
                showStatus('Error clearing log: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.classList.remove('loading');
            }
        }

        function getCloudServices() {
            energyApi.getMqttCloudServices()
                .then(data => {
                    document.getElementById("cloudServices").checked = data.enabled;
                })
                .catch(error => {
                    console.log("Error getting cloud services status. Response: " + error.message);
                });
        }

        async function setCloudServices() {
            const button = document.getElementById("setCloudServicesButton");
            button.disabled = true;
            button.classList.add('loading');

            try {
                showStatus('Updating cloud services...', 'info');

                // First check secrets status
                const secretsResponse = await energyApi.getSystemSecrets();
                const isEnabled = document.getElementById("cloudServices").checked;

                // If no secrets but cloud services is checked, prevent that
                if (!secretsResponse.hasSecrets && isEnabled) {
                    showStatus('Cannot enable: firmware does not include secrets', 'error');
                    document.getElementById("cloudServices").checked = false;
                    button.disabled = false;
                    button.classList.remove('loading');
                    return;
                }

                // Send the configuration
                await energyApi.setMqttCloudServices(isEnabled);

                showStatus('Cloud services updated', 'success');
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.classList.remove('loading');
            }
        }

        function getLedBrightness() {
            energyApi.getLedBrightness()
                .then(data => {
                    // Assuming API returns brightness as 0-100 range
                    document.getElementById("ledBrightness").value = data.brightness;
                    updateBrightnessValue();
                })
                .catch(error => {
                    console.log("Error getting LED brightness. Response: " + error.message);
                });
        }

        async function setLedBrightness() {
            const button = document.getElementById("setLedBrightnessButton");
            button.disabled = true;
            button.classList.add('loading');

            try {
                showStatus('Setting brightness...', 'info');

                const brightness = parseInt(document.getElementById("ledBrightness").value);
                await energyApi.setLedBrightness(brightness);

                showStatus('Brightness set successfully', 'success');
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.classList.remove('loading');
            }
        }

        function updateBrightnessValue() {
            var slider = document.getElementById("ledBrightness");
            var output = document.getElementById("ledBrightnessValue");
            var percentage = parseInt(slider.value);
            slider.style.setProperty('--slider-value', percentage + '%');
            slider.title = percentage + "%";
            output.innerHTML = percentage + "%";
        }

        function checkHasSecrets() {
            energyApi.getSystemSecrets()
                .then(response => {
                    // If no secrets available, disable cloud services option
                    if (!response.hasSecrets) {
                        var cloudServicesCheckbox = document.getElementById("cloudServices");
                        cloudServicesCheckbox.disabled = true;
                        cloudServicesCheckbox.checked = false;

                        // Create warning message if it doesn't exist
                        if (!document.getElementById("cloud-services-warning")) {
                            var warningDiv = document.createElement("div");
                            warningDiv.id = "cloud-services-warning";
                            warningDiv.className = "warning-box";
                            warningDiv.style.backgroundColor = "#fff3cd";
                            warningDiv.style.color = "#856404";
                            warningDiv.style.padding = "10px";
                            warningDiv.style.borderRadius = "5px";
                            warningDiv.style.marginTop = "10px";
                            warningDiv.innerHTML = "‚ö†Ô∏è Cloud services require secrets to be included in the firmware. This build doesn't include secrets.";

                            // Insert after the cloud services label
                            var labelElement = document.querySelector("label[for='cloudServices']");
                            labelElement.parentNode.insertBefore(warningDiv, labelElement.nextSibling);
                        }
                    }
                })
                .catch(error => {
                    console.log("Error checking secrets status:", error.message);
                });
        }

        // Sequential API loading to prevent overwhelming the ESP32
        async function loadConfigurationData() {
            const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
            const DELAY_BETWEEN_REQUESTS = 100;

            try {
                console.log("Loading configuration data sequentially...");

                await getCloudServices();
                await delay(DELAY_BETWEEN_REQUESTS);

                await getLedBrightness();
                await delay(DELAY_BETWEEN_REQUESTS);

                await getLogLevel();
                await delay(DELAY_BETWEEN_REQUESTS);

                await checkHasSecrets();

                console.log("Configuration data loaded successfully");

            } catch (error) {
                console.error("Error loading configuration data:", error);
                showStatus('Error loading configuration data. Please refresh the page.', 'error', 10000);
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            // Load configuration data sequentially to prevent ESP32 overload
            loadConfigurationData();
        });

    </script>

</body>

</html>