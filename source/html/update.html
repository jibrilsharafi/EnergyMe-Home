<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" type="text/css" href="/css/button.css">
    <link rel="stylesheet" type="text/css" href="/css/main.css">
    <link rel="stylesheet" type="text/css" href="/css/section.css">
    <link rel="stylesheet" type="text/css" href="/css/typography.css">

    <link rel="icon" type="image/png" href="/images/favicon.png">
    
    <title>Update</title>
</head>

<body>
    <div class="buttonNavigation-container">
        <a class="buttonNavigation" type="home" href="/">Home</a>
    </div>
    <div id="update" class="section-box">
        <h2>Update</h2>
        <p>Upload a new firmware to the device (only <i>.bin</i> files are allowed)</p>
        <form method='POST' action='/do-update' enctype='multipart/form-data' onsubmit="return formSubmitted()">
            <input type='file' id='file' name='update' accept='.bin' required>
            <input type='submit' id='submit' value='Update'>
        </form>
    </div>

    <div id="current-device" class="section-box">
        <h2>Current device</h2>
        <h3>Firmware</h3>
        <p><span class='list-key'>Version:</span><span id='current-firmware-version' class='list-value'></span></p>
        <p><span class='list-key'>Date:</span><span id='current-firmware-date' class='list-value'></span></p>
    </div>

    <div id="update-info" class="section-box">
        <h2>Update Information</h2>
        <div id="update-details" style="display: none;">
            <p><span class='list-key'>Version:</span><span id='update-version' class='list-value'></span></p>
            <p><span class='list-key'>Date:</span><span id='update-date' class='list-value'></span></p>
            <p><span class='list-key'>SHA256:</span><span id='update-sha256' class='list-value'></span></p>
            <p><span class='list-key'>URL:</span><a id='update-url' href='' target='_blank'></a></p>
        </div>
        <p id="no-update" class="light-grey-box">Latest version installed</p>
    </div>

    <div id="update-status" class="section-box">
        <h2>Update Status</h2>
        <div id="status-details" style="display: none;">
            <p><span class='list-key'>Status:</span><span id='status' class='list-value'></span></p>
            <p><span class='list-key'>Reason:</span><span id='reason' class='list-value'></span></p>
            <p><span class='list-key'>Updated:</span><span id='timestamp' class='list-value'></span></p>
        </div>
        <p id="no-status" class="light-grey-box">No update status available</p>
    </div>

    <script>
        function formSubmitted() {
            var res = confirm("Are you sure you want to update the device?");
            if (!res) {
                return false;
            }
            document.getElementById("submit").value = "Updating...";
            document.getElementById("submit").disabled = true;
            return true;
        }

        function getDeviceInfo() {
            var request = new XMLHttpRequest();
            request.open('GET', '/rest/device-info', true);
            request.onload = function () {
                if (request.status == 200) {
                    var data = JSON.parse(request.responseText);
                    document.getElementById("current-firmware-version").innerHTML = data.firmware.buildVersion;
                    document.getElementById("current-firmware-date").innerHTML = data.firmware.buildDate;
                } else {
                    console.log("Error getting device info");
                }
            };
            request.send();
        }

        function getFirmwareUpdateInfo() {
            var request = new XMLHttpRequest();
            request.open('GET', '/rest/firmware-update-info', true);
            request.onload = function () {
                if (request.status == 200) {
                    var data = JSON.parse(request.responseText);
                    if (Object.keys(data).length === 0) {
                        document.getElementById("update-details").style.display = "none";
                        document.getElementById("no-update").style.display = "block";
                    } else {
                        document.getElementById("update-version").innerHTML = data.buildVersion;
                        document.getElementById("update-date").innerHTML = data.buildDate;
                        document.getElementById("update-sha256").innerHTML = data.sha256;
                        document.getElementById("update-url").innerHTML = data.url;
                        document.getElementById("update-url").href = data.url;
                        document.getElementById("update-details").style.display = "block";
                        document.getElementById("no-update").style.display = "none";
                    }
                } else {
                    console.log("Error getting firmware update info");
                }
            };
            request.send();
        }

        function getFirmwareUpdateStatus() {

            const happyDays = [
                "That was such a happy day",
                "That was a day full of joy",
                "Oh man, that was a happy day",
                "That was a day to remember",
                "I wish every day I could update the firmware",
                "That was a day full of 1's and 0's",
                "That was a day full of binary",
                "That was a day full of 0x01 and 0x00",
                "That was a day full of energy (get the pun?)",
                "What an electrifying day"
            ];

            const sadDays = [
                "Why did the update fail?!?",
                "Oh no! I really wanted to update the firmware that day"
            ];

            var request = new XMLHttpRequest();
            request.open('GET', '/rest/firmware-update-status', true);
            request.onload = function () {
                if (request.status == 200) {
                    var data = JSON.parse(request.responseText);
                    if (Object.keys(data).length === 0) {
                        document.getElementById("status-details").style.display = "none";
                        document.getElementById("no-status").style.display = "block";
                    } else {
                        var status = data.status.toUpperCase();
                        var statusElement = document.getElementById("status");

                        statusElement.innerHTML = status;

                        if (status === "FAILED") {
                            statusElement.style.color = "red";
                            document.getElementById("reason").innerHTML = data.reason;

                            document.getElementById("status").innerHTML = sadDays[Math.floor(Math.random() * sadDays.length)];
                        } else if (status === "SUCCESS") {
                            statusElement.style.color = "green";
                            document.getElementById("reason").style.display = "none";

                            document.getElementById("status").innerHTML = happyDays[Math.floor(Math.random() * happyDays.length)];
                        }

                        var timestamp = new Date(data.timestamp);
                        document.getElementById("timestamp").innerHTML = timestamp.toLocaleString();

                        document.getElementById("status-details").style.display = "block";
                        document.getElementById("no-status").style.display = "none";
                    }
                } else {
                    console.log("Error getting firmware update status");
                }
            };
            request.send();
        }

        getDeviceInfo();
        getFirmwareUpdateInfo();
        getFirmwareUpdateStatus();
    </script>
</body>

</html>