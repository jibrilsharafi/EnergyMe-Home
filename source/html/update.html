<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" type="text/css" href="/css/button.css">
    <link rel="stylesheet" type="text/css" href="/css/main.css">
    <link rel="stylesheet" type="text/css" href="/css/section.css">
    <link rel="stylesheet" type="text/css" href="/css/typography.css">

    <link rel="icon" type="image/png" href="/images/favicon.png">
    
    <title>Update</title>
</head>

<body>
    <div class="buttonNavigation-container">
        <a class="buttonNavigation" type="home" href="/">Home</a>
    </div>
    <div id="update" class="section-box">
        <h2>Update</h2>
        <p>Upload a new firmware to the device (only <i>.bin</i> files are allowed)</p>
        <form method='POST' action='/do-update' enctype='multipart/form-data' onsubmit="return formSubmitted()">
            <input type='file' id='file' name='update' accept='.bin' required>
            <input type='submit' id='submit' value='Update'>
        </form>
    </div>

    <div id="current-device" class="section-box">
        <h2>Current device</h2>
        <h3>Firmware</h3>
        <p>Version: <span id="current-firmware-version"></span></p>
        <p>Date: <span id="current-firmware-date"></span></p>
    </div>

    <div id="update-info" class="section-box">
        <h2>Update Information</h2>
        <div id="update-details" style="display: none;">
            <p>Version: <span id="update-version"></span></p>
            <p>Date: <span id="update-date"></span></p>
            <p>SHA256: <span id="update-sha256"></span></p>
            <p>URL: <a id="update-url" href="" target="_blank"></a></p>
        </div>
        <p id="no-update" class="light-grey-box">Latest version installed</p>
    </div>

    <div id="update-status" class="section-box">
        <h2>Update Status</h2>
        <div id="status-details" style="display: none;">
            <p>Status: <span id="status"></span></p>
            <p>Reason: <span id="reason"></span></p>
            <p>Timestamp: <span id="timestamp"></span></p>
        </div>
        <p id="no-status" class="light-grey-box">No update status available</p>
    </div>

    <script>
        function formSubmitted() {
            var res = confirm("Are you sure you want to update the device?");
            if (!res) {
                return false;
            }
            document.getElementById("submit").value = "Updating...";
            document.getElementById("submit").disabled = true;
            return true;
        }

        function getCurrentDeviceInfo() {
            var request = new XMLHttpRequest();
            request.open('GET', '/rest/device-info', true);
            request.onload = function () {
                if (request.status >= 200 && request.status < 400) {
                    var data = JSON.parse(request.responseText);
                    document.getElementById("current-firmware-version").innerHTML = data.firmware.version;
                    document.getElementById("current-firmware-date").innerHTML = data.firmware.date;

                    var elements = document.querySelectorAll("#current-firmware-version, #current-firmware-date");
                    for (var i = 0; i < elements.length; i++) {
                        elements[i].style.fontStyle = "italic";
                    }
                } else {
                    console.log("Error getting current firmware");
                }
            };
            request.send();
        }

        function getFirmwareUpdateInfo() {
            var request = new XMLHttpRequest();
            request.open('GET', '/rest/firmware-update-info', true);
            request.onload = function () {
                if (request.status >= 200 && request.status < 400) {
                    var data = JSON.parse(request.responseText);
                    if (Object.keys(data).length === 0) {
                        document.getElementById("update-details").style.display = "none";
                        document.getElementById("no-update").style.display = "block";
                    } else {
                        document.getElementById("update-version").innerHTML = data.version;
                        document.getElementById("update-date").innerHTML = data.date;
                        document.getElementById("update-sha256").innerHTML = data.sha256;
                        document.getElementById("update-url").innerHTML = data.url;
                        document.getElementById("update-url").href = data.url;
                        document.getElementById("update-details").style.display = "block";
                        document.getElementById("no-update").style.display = "none";
                    }
                } else {
                    console.log("Error getting firmware update info");
                }
            };
            request.send();
        }

        function getFirmwareUpdateStatus() {
            var request = new XMLHttpRequest();
            request.open('GET', '/rest/firmware-update-status', true);
            request.onload = function () {
                if (request.status >= 200 && request.status < 400) {
                    var data = JSON.parse(request.responseText);
                    if (Object.keys(data).length === 0) {
                        document.getElementById("status-details").style.display = "none";
                        document.getElementById("no-status").style.display = "block";
                    } else {
                        document.getElementById("status").innerHTML = data.status;
                        document.getElementById("reason").innerHTML = data.reason;
                        document.getElementById("timestamp").innerHTML = data.timestamp;
                        document.getElementById("status-details").style.display = "block";
                        document.getElementById("no-status").style.display = "none";
                    }
                } else {
                    console.log("Error getting firmware update status");
                }
            };
            request.send();
        }

        getCurrentDeviceInfo();
        getFirmwareUpdateInfo();
        getFirmwareUpdateStatus();
    </script>
</body>

</html>