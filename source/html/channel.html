<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" type="text/css" href="/css/button.css">
    <link rel="stylesheet" type="text/css" href="/css/styles.css">
    <link rel="stylesheet" type="text/css" href="/css/section.css">
    <link rel="stylesheet" type="text/css" href="/css/typography.css">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">

    <title>Channel</title>
    <style>
        .channel-columns {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 10px;
            justify-items: center;
        }

        .channel-columns input[type="text"] {
            width: 90%;
            box-sizing: border-box;
        }
    </style>
</head>

<body>
    <div class="buttonNavigation-container">
        <a class="buttonNavigation" type="outer" href="/configuration">⚙️ Configuration</a>
    </div>    <div id="channelContainer" class="section-box" style="text-align: center;">
        <h1>Channels</h1>
        <div id="updateStatus" style="height: 20px; color: #666; font-style: italic;"></div>
        <div class="channel-columns"></div>
    </div>
</body>
<script src="/js/api-client.js"></script>
<script>
    var channelData = {};
    var powerUpdateInterval = null;
    const FETCH_THROTTLE = 2000; // Increased for better stability
    var updateQueue = {};
    var isProcessingUpdate = false;

    // Initialize the page
    async function initializePage() {
        try {
            document.getElementById('updateStatus').textContent = 'Loading...';
            
            // Load channel config only
            const channelResponse = await energyApi.getChannelConfig();
            channelData = channelResponse;
            
            createChannelBoxes();
            document.getElementById('updateStatus').textContent = '';
        } catch (error) {
            console.error('Error initializing page:', error);
            document.getElementById('updateStatus').textContent = 'Error loading data: ' + error.message;
        }
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', initializePage);

    function createChannelBoxes() {
        const container = document.querySelector('.channel-columns');
        container.innerHTML = ''; // Clear existing content

        if (!channelData || Object.keys(channelData).length === 0) {
            container.innerHTML = '<p>No channel data available</p>';
            return;
        }

        Object.entries(channelData).forEach(([index, channel]) => {
            const box = document.createElement('div');
            box.className = 'section-box';
            box.style.textAlign = 'center';

            const phaseOptions = [1, 2, 3]
                .map(phase => `<option value="${phase}" ${phase === channel.phase ? 'selected' : ''}>${phase}</option>`)
                .join('');

            // Check if this is channel 0 (main voltage channel)
            const isChannel0 = index == 0;
            const activeCheckboxDisabled = isChannel0 ? 'disabled' : '';
            const activeChecked = isChannel0 ? 'checked' : (channel.active ? 'checked' : '');

            box.innerHTML = `
                <h3>Channel ${index}</h3>
                <label>
                    Label:
                    <input type="text" value="${channel.label || ''}" id="label${index}" onchange="queueChannelUpdate(${index})">
                </label>
                <div style="height: 10px;"></div>
                <label>
                    Phase:
                    <select id="phase${index}" onchange="queueChannelUpdate(${index})">
                        ${phaseOptions}
                    </select>
                </label>
                <div style="height: 10px;"></div>
                <label>
                    <input type="checkbox" ${channel.reverse ? 'checked' : ''} id="reverse${index}" onchange="queueChannelUpdate(${index})">
                    Reverse
                </label>
                <div style="height: 10px;"></div>
                <label>
                    <input type="checkbox" ${activeChecked} id="active${index}" onchange="queueChannelUpdate(${index})" ${activeCheckboxDisabled}>
                    Active ${isChannel0 ? '(Main voltage - cannot be disabled)' : ''}
                </label>
                <div style="height: 10px;"></div>
                <span id="power${index}" style="font-weight: bold; color: #333;"></span>
            `;
            container.appendChild(box);

            if (channel.active) {
                startPowerUpdate(index);
            }
        });

        // Start global power updates if we have any active channels
        startGlobalPowerUpdates();
    }

    function startGlobalPowerUpdates() {
        // Stop any existing interval
        if (powerUpdateInterval) {
            clearInterval(powerUpdateInterval);
        }

        const updateAllPowerValues = async () => {
            try {
                const meterValuesArray = await energyApi.getMeterValues();
                
                // Update only active channels
                meterValuesArray.forEach(channelMeterData => {
                    const index = channelMeterData.index;
                    const powerElement = document.getElementById(`power${index}`);
                    
                    // Only show power if channel is active
                    if (powerElement && channelData[index] && channelData[index].active && 
                        channelMeterData.data && channelMeterData.data.activePower !== undefined) {
                        powerElement.innerHTML = `${channelMeterData.data.activePower.toFixed(1)} W`;
                    } else if (powerElement && channelData[index] && !channelData[index].active) {
                        // Clear power display for inactive channels
                        powerElement.innerHTML = '';
                    }
                });
                
            } catch (error) {
                console.error('Error fetching power values:', error);
                // Show error only on active channels
                Object.keys(channelData).forEach(index => {
                    if (channelData[index].active) {
                        const powerElement = document.getElementById(`power${index}`);
                        if (powerElement) {
                            powerElement.innerHTML = 'Error';
                        }
                    }
                });
            }
        };

        // Initial update
        updateAllPowerValues();
        
        // Set up interval for regular updates
        powerUpdateInterval = setInterval(updateAllPowerValues, FETCH_THROTTLE);
    }

    function stopGlobalPowerUpdates() {
        if (powerUpdateInterval) {
            clearInterval(powerUpdateInterval);
            powerUpdateInterval = null;
        }
    }

    function startPowerUpdate(index) {
        // Individual channel power updates are now handled by the global update
        // Just ensure the power display is visible for this channel
        const powerElement = document.getElementById(`power${index}`);
        if (powerElement && channelData[index] && channelData[index].active) {
            powerElement.innerHTML = 'Loading...';
        }
    }

    function stopPowerUpdate(index) {
        // Clear individual channel power display
        const powerElement = document.getElementById(`power${index}`);
        if (powerElement) {
            powerElement.innerHTML = '';
        }
    }    function queueChannelUpdate(index) {
        // Prevent channel 0 from being disabled
        if (index == 0) {
            const activeCheckbox = document.getElementById(`active${index}`);
            if (activeCheckbox && !activeCheckbox.checked) {
                activeCheckbox.checked = true;
                alert('Channel 0 is the main voltage channel and cannot be disabled.');
                return;
            }
        }

        const channelUpdate = {
            index: parseInt(index),
            label: document.getElementById(`label${index}`).value,
            reverse: document.getElementById(`reverse${index}`).checked,
            phase: parseInt(document.getElementById(`phase${index}`).value),
            active: document.getElementById(`active${index}`).checked
        };

        // Update local channelData immediately for UI responsiveness
        if (channelData[index]) {
            channelData[index].active = channelUpdate.active;
            channelData[index].label = channelUpdate.label;
            channelData[index].reverse = channelUpdate.reverse;
            channelData[index].phase = channelUpdate.phase;
        }

        // Store in queue - this will overwrite any previous update for this channel
        updateQueue[index] = channelUpdate;
        
        // Update UI responsiveness immediately
        if (channelUpdate.active) {
            startPowerUpdate(index);
        } else {
            stopPowerUpdate(index);
        }

        // Restart global power updates to include/exclude this channel
        startGlobalPowerUpdates();

        // Process updates after a short delay (debouncing)
        if (!isProcessingUpdate) {
            isProcessingUpdate = true;
            setTimeout(processChannelUpdates, 500);
        }
    }

    async function processChannelUpdates() {
        if (Object.keys(updateQueue).length === 0) {
            isProcessingUpdate = false;
            return;
        }

        try {
            document.getElementById('updateStatus').textContent = 'Updating channels...';
            
            // Send all queued updates using PATCH for partial updates
            const updates = Object.values(updateQueue);
            updateQueue = {}; // Clear queue
            
            for (const update of updates) {
                await energyApi.patchChannelConfig(update.index, update);
            }
            
            document.getElementById('updateStatus').textContent = 'Channels updated successfully';
            setTimeout(() => {
                document.getElementById('updateStatus').textContent = '';
            }, 2000);
            
        } catch (error) {
            console.error('Error updating channels:', error);
            
            if (error.message.includes('Channel 0 cannot be disabled')) {
                document.getElementById('updateStatus').textContent = 'Channel 0 cannot be disabled';
                alert('Channel 0 is the main voltage channel and cannot be disabled.');
                // Reset channel 0 to active in UI
                const activeCheckbox = document.getElementById('active0');
                if (activeCheckbox) {
                    activeCheckbox.checked = true;
                }
            } else {
                document.getElementById('updateStatus').textContent = 'Error: ' + error.message;
                alert('Error updating channels: ' + error.message);
            }
            
            setTimeout(() => {
                document.getElementById('updateStatus').textContent = '';
            }, 5000);
        }
        
        isProcessingUpdate = false;
        
        // If there are new updates in queue, process them
        if (Object.keys(updateQueue).length > 0) {
            setTimeout(processChannelUpdates, 500);
        }
    }</script>

</html>