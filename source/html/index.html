<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" type="text/css" href="/css/button.css">
    <link rel="stylesheet" type="text/css" href="/css/styles.css">
    <link rel="stylesheet" type="text/css" href="/css/section.css">
    <link rel="stylesheet" type="text/css" href="/css/typography.css">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">

    <script src="/js/api-client.js"></script>

    <title>EnergyMe</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .header {
            font-size: 96px;
            margin-bottom: 10px;
            text-align: center;
        }

        .subheader {
            font-size: 32px;
            margin-bottom: 20px;
            text-align: center;
            color: #808080;
        }

        .voltage-box {
            text-align: center;
            font-size: 20px;
            margin-bottom: 20px;
            margin-top: 5px;
        }

        .channels-box {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
        }

        .channel-box {
            width: 18%;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-sizing: border-box;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
            padding: 10px;
            text-align: center;
        }

        .channel-label {
            font-size: 24px;
            margin-bottom: 5px;
            font-weight: bold;
        }        .channel-value {
            font-style: italic;
            color: #808080;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
        }
    </style>
</head>

<body>    <div class="header">EnergyMe</div>
    <div class="subheader">Home</div>
    
    <div class="buttonNavigation-container">
        <a class="buttonNavigation" type="inner" href="/info">üí° Info</a>
        <a class="buttonNavigation" type="inner" href="/configuration">‚öôÔ∏è Configuration</a>
        <a class="buttonNavigation" type="inner" href="/update">üöÄ Update</a>
        <a class="buttonNavigationExternal" type="inner" href="/swagger-ui" target="_blank">üìö API Docs</a>
    </div>

    <div class="section-box">
        <div id="voltage" class="voltage-box"></div>
        <div id="channels" class="channels-box"></div>
    </div>

    <div class="section-box">
        <div id="consumption-chart" style="position: relative;">
            <canvas id="consumption-chart-canvas"></canvas>
            <button id="download-csv" class="tooltip" style="position: absolute; top: 2px; right: 2px;">
                <i class="fas fa-download"></i>
                <span class="tooltiptext">Download as CSV</span>
            </button>
        </div>
    </div>

    <div class="section-box">
        <div id="pie-chart">
            <canvas id="pie-chart-canvas"></canvas>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>

<script>
    var colors = [
        'rgba(0,123,255,0.5)', 'rgba(255,0,0,0.5)', 'rgba(0,255,0,0.5)', 'rgba(255,255,0,0.5)', 'rgba(0,255,255,0.5)',
        'rgba(123,0,255,0.5)', 'rgba(255,0,123,0.5)', 'rgba(0,255,123,0.5)', 'rgba(255,255,123,0.5)', 'rgba(123,255,0,0.5)',
        'rgba(0,123,0,0.5)', 'rgba(123,0,0,0.5)', 'rgba(0,0,123,0.5)', 'rgba(123,123,123,0.5)', 'rgba(255,255,255,0.5)',
        'rgba(0,0,255,0.5)', 'rgba(255,0,255,0.5)', 'rgba(255,123,0,0.5)'
    ];

    var dailyEnergy = {};
    var channelData = {};
    var meterData = {};

    function getDailyEnergy() {
        // Note: daily-energy endpoint not available in current API
        // This would need to be implemented using file list and individual file reads
        console.warn('Daily energy endpoint not yet implemented in new API');
        dailyEnergy = {};
    }

    function getChannelData() {
        energyApi.getChannelConfig()
            .then(data => {
                channelData = data;
            })
            .catch(error => {
                console.error('Error getting channel data:', error);
            });
    }

    function getMeterData() {
        energyApi.getMeterValues()
            .then(data => {
                meterData = data;
            })
            .catch(error => {
                console.error('Error getting meter data:', error);
            });
    }

    function updateMeterData() {
        document.getElementById("voltage").innerHTML = meterData[0].data.voltage.toFixed(1) + ' V';

        var powerDataHtml = '';
        var channelCount = 0;
        var totalPower = 0;
        for (var channel in meterData) {
            var label = meterData[channel].label;
            var activePower = meterData[channel].data.activePower.toFixed(0);

            powerDataHtml += '<div class="channel-box">';
            powerDataHtml += '<div class="channel-label">' + label + '</div>';
            powerDataHtml += '<div class="channel-value">' + activePower + ' W</div>';
            powerDataHtml += '</div>';

            if (channelCount > 0) {
                totalPower += parseFloat(activePower);
            }
            channelCount++;
        }

        document.getElementById("channels").innerHTML = powerDataHtml;
    }

    function parseDailyEnergy() {
        var dailyActiveEnergy = {};

        for (var date in dailyEnergy) {
            for (var channel in dailyEnergy[date]) {
                if (!dailyActiveEnergy[date]) {
                    dailyActiveEnergy[date] = {};
                }

                dailyActiveEnergy[date][channel] = dailyEnergy[date][channel].activeEnergyImported / 1000;
            }
        }

        var firstDay = Object.keys(dailyActiveEnergy)[0];
        var lastDay = Object.keys(dailyActiveEnergy)[Object.keys(dailyActiveEnergy).length - 1];

        var listMissingDays = [];
        var currentDate = new Date(firstDay);
        var lastDate = new Date(lastDay);

        while (currentDate < lastDate) {
            currentDate.setDate(currentDate.getDate() + 1);
            var date = currentDate.toISOString().split('T')[0];

            if (!dailyActiveEnergy[date]) {
                dailyActiveEnergy[date] = {};
            }
        }

        var dailyActiveEnergyDifference = {};

        var dates = Object.keys(dailyActiveEnergy).sort();
        for (var i = 0; i < dates.length; i++) {
            var date = dates[i];
            var previousDate = dates[i - 1];

            dailyActiveEnergyDifference[date] = {};

            for (var channel in dailyActiveEnergy[date]) {
                var currentDayEnergy = dailyActiveEnergy[date][channel];
                var previousDayEnergy = i > 0 ? dailyActiveEnergy[previousDate][channel] || 0 : 0;

                dailyActiveEnergyDifference[date][channel] = currentDayEnergy - previousDayEnergy;
            }
        }

        dailyActiveEnergy = addOtherDailyEnergy(dailyActiveEnergyDifference);
        dailyActiveEnergy = renameDailyActiveEnergyDifference(dailyActiveEnergy, channelData);

        return dailyActiveEnergy;
    }

    function addOtherDailyEnergy(dailyActiveEnergyDifference) {

        for (var date in dailyActiveEnergyDifference) {

            var generalEnergy = dailyActiveEnergyDifference[date]["0"];
            var otherEnergy = 0;

            for (var channel in dailyActiveEnergyDifference[date]) {
                if (channel !== "0") {
                    otherEnergy += dailyActiveEnergyDifference[date][channel];
                }
            }

            dailyActiveEnergyDifference[date]['Other'] = generalEnergy - otherEnergy;
            delete dailyActiveEnergyDifference[date]["0"];
        }

        return dailyActiveEnergyDifference;
    }

    function renameDailyActiveEnergyDifference(dailyActiveEnergyDifference, channelData) {

        for (var date in dailyActiveEnergyDifference) {

            for (var channel in dailyActiveEnergyDifference[date]) {
                if (channel !== "Other") {
                    var channelIndex = parseInt(channel);
                    var channelLabel = channelData[channelIndex].label;

                    dailyActiveEnergyDifference[date][channelLabel] = dailyActiveEnergyDifference[date][channel];
                    delete dailyActiveEnergyDifference[date][channel];
                }
            }

            otherEnergy = dailyActiveEnergyDifference[date]['Other'];
            delete dailyActiveEnergyDifference[date]['Other'];
            dailyActiveEnergyDifference[date]['Other'] = otherEnergy;
        }

        return dailyActiveEnergyDifference;
    }

    function getTotalActiveEnergy() {
        var totalActiveEnergy = {};

        for (var channel in meterData) {
            totalActiveEnergy[meterData[channel].index] = meterData[channel].data.activeEnergyImported / 1000;
        }

        totalActiveEnergy = addTotalOtherEnergy(totalActiveEnergy);
        totalActiveEnergy = renameTotalActiveEnergy(totalActiveEnergy, channelData);

        return totalActiveEnergy;
    }

    function addTotalOtherEnergy(totalActiveEnergy) {
        var totalGeneralEnergy = totalActiveEnergy["0"];
        var totalOtherEnergy = 0;

        for (var channel in totalActiveEnergy) {
            if (channel !== "0") {
                totalOtherEnergy += totalActiveEnergy[channel];
            }
        }

        totalActiveEnergy['Other'] = totalGeneralEnergy - totalOtherEnergy;
        delete totalActiveEnergy["0"];

        return totalActiveEnergy;
    }

    function renameTotalActiveEnergy(totalActiveEnergy, channelData) {

        for (var channel in totalActiveEnergy) {
            if (channel !== "Other") {
                var channelIndex = parseInt(channel);
                var channelLabel = channelData[channelIndex].label;

                totalActiveEnergy[channelLabel] = totalActiveEnergy[channel];
                delete totalActiveEnergy[channel];
            }

            otherEnergy = totalActiveEnergy['Other'];
            delete totalActiveEnergy['Other'];
            totalActiveEnergy['Other'] = otherEnergy;
        }

        return totalActiveEnergy;
    }

    function getActiveChannels() {
        // Get channels that have non-zero power consumption
        const activeChannels = [];
        for (var channel in meterData) {
            if (meterData[channel].data.activePower > 0) {
                activeChannels.push(meterData[channel].label);
            }
        }
        // Always include 'Other' channel
        if (!activeChannels.includes('Other')) {
            activeChannels.push('Other');
        }
        return activeChannels;
    }

    function plotConsumptionChart(consumptionData) {
        var labels = Object.keys(consumptionData);

        // Get active channels
        const activeChannels = getActiveChannels();

        var datasets = [];
        var channels = Object.keys(consumptionData[labels[0]])
            .filter(channel => activeChannels.includes(channel));

        channels.forEach(function (channel, i) {
            var data = labels.map(function (label) {
                var value = consumptionData[label][channel];
                if (isNaN(value)) {
                    value = 0;
                }
                if (value >= 1000) {
                    return value.toFixed(0);
                } else if (value >= 100) {
                    return value.toFixed(1);
                } else if (value >= 10) {
                    return value.toFixed(2);
                } else {
                    return value.toFixed(3);
                }
            });

            datasets.push({
                label: channel,
                data: data,
                backgroundColor: colors[i % colors.length],
                borderColor: colors[i % colors.length],
                borderWidth: 1
            });
        });

        var ctx = document.getElementById('consumption-chart-canvas').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                scales: {
                    x: {
                        stacked: true
                    },
                    y: {
                        stacked: true,
                        title: {
                            display: true,
                            text: 'kWh'
                        }
                    }
                }
            }
        });

        // Update CSV download functionality
        document.getElementById('download-csv').addEventListener('click', function () {
            var csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "time," + channels.join(",") + "\n";

            labels.forEach(function (label) {
                var row = [label];
                channels.forEach(function (channel) {
                    row.push(consumptionData[label][channel]);
                });
                csvContent += row.join(",") + "\n";
            });

            var encodedUri = encodeURI(csvContent);
            var link = document.createElement("a");
            var now = new Date();
            var timestamp = now.toISOString().replace(/[:.-]/g, "_");
            var filename = "consumption_data_" + timestamp + ".csv";
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);

            link.click();
            document.body.removeChild(link);
        });
    }

    function plotPieChart(consumptionData) {
        var labels = Object.keys(consumptionData);
        var data = Object.values(consumptionData).map(value => isNaN(value) ? 0 : value); // Replace NaN with 0

        var totalConsumption = data.reduce(function (acc, value) {
            return acc + value;
        }, 0);

        labels = labels.map(function (label, i) {
            var percentage = ((data[i] / totalConsumption) * 100).toFixed(1);
            return label + ' (' + percentage + '%)';
        });

        var ctx = document.getElementById('pie-chart-canvas').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut', // Use 'doughnut' type for a pie chart with a hole inside
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors.slice(0, labels.length),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    function plotCharts() {
        Promise.all([
            // Note: daily-energy endpoint removed - not in current API
            // Using channel config and meter values only for now
            Promise.resolve({}), // placeholder for daily energy
            energyApi.getChannelConfig(), 
            energyApi.getMeterValues()
        ])
            .then(data => {
                dailyEnergy = data[0]; // Will be empty until daily energy endpoint is implemented
                channelData = data[1];
                meterData = data[2];

                updateMeterData();

                // Disable charts until daily energy data is available
                if (Object.keys(dailyEnergy).length === 0) {
                    document.getElementById("consumption-chart").innerHTML = "üìä Daily energy tracking is not yet available in the new API.<br><br>This feature will be implemented in a future update.";
                    document.getElementById("consumption-chart").style.textAlign = "center";
                    document.getElementById("consumption-chart").style.fontSize = "18px";
                    document.getElementById("consumption-chart").style.color = "#666";
                    document.getElementById("consumption-chart").style.padding = "40px";

                    // Hide the download button
                    if (document.getElementById("download-csv")) {
                        document.getElementById("download-csv").style.display = "none";
                    }

                    document.getElementById("pie-chart").innerHTML = "ü•ß Total energy consumption chart is not yet available.<br><br>This feature will be implemented in a future update.";
                    document.getElementById("pie-chart").style.textAlign = "center";
                    document.getElementById("pie-chart").style.fontSize = "18px";
                    document.getElementById("pie-chart").style.color = "#666";
                    document.getElementById("pie-chart").style.padding = "40px";
                } else {
                    dailyActiveEnergy = parseDailyEnergy();
                    plotConsumptionChart(dailyActiveEnergy);

                    totalActiveEnergy = getTotalActiveEnergy();
                    plotPieChart(totalActiveEnergy);
                }

            })
            .catch(error => console.error('Error:', error));
    }

    async function fetchFirmwareUpdateInfo() {
        try {
            const data = await energyApi.getFirmwareUpdateInfo();
            if (data.latest == false) {
                document.querySelector('.buttonNavigation[href="/update"]').innerHTML += ' &#x1F514';
            }
        } catch (error) {
            console.error('Error fetching firmware update info:', error);
        }
    }    plotCharts();
    fetchFirmwareUpdateInfo();

    setInterval(function () {
        getMeterData();
        updateMeterData();
    }, 1000);

</script>

</html>