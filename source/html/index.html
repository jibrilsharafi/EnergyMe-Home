<!-- SPDX-License-Identifier: GPL-3.0-or-later -->
<!-- Copyright (C) 2025 Jibril Sharafi -->

<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" type="text/css" href="/css/button.css">
    <link rel="stylesheet" type="text/css" href="/css/styles.css">
    <link rel="stylesheet" type="text/css" href="/css/section.css">
    <link rel="stylesheet" type="text/css" href="/css/typography.css">
    <link rel="stylesheet" type="text/css" href="/css/forms.css">
    <link rel="stylesheet" type="text/css" href="/css/index.css">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">

    <title>EnergyMe</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
    <div class="header">EnergyMe</div>
    <div class="subheader">Home</div>
    
    <div class="buttonNavigation-container">
        <a class="buttonNavigation" type="inner" href="/info">üí° Info</a>
        <a class="buttonNavigation" type="inner" href="/configuration">‚öôÔ∏è Configuration</a>
        <a class="buttonNavigation" type="inner" href="/integrations">üîó Integrations</a>
        <a class="buttonNavigation" type="inner" href="/update">üöÄ Update</a>
    </div>

    <!-- Energy Flow Diagram - Simple Layout -->
    <div id="energy-flow-section" class="section-box energy-flow-section">
        <div class="power-flow">
            <!-- Main flow area -->
            <div class="power-flow-main">
                <!-- Top: Solar (optional) -->
                <div id="pf-solar" class="pf-node pf-solar" style="display: none;">
                    <div class="pf-icon">‚òÄÔ∏è</div>
                    <div class="pf-value" id="solar-power">0 W</div>
                    <div class="pf-connector pf-connector-bottom"></div>
                </div>
                
                <!-- Middle row: Grid - Center - Home -->
                <div class="pf-middle-row">
                    <div id="pf-grid" class="pf-node pf-grid">
                        <div class="pf-icon">‚ö°</div>
                        <div class="pf-value" id="grid-power">0 W</div>
                        <div class="pf-connector pf-connector-right"></div>
                    </div>
                    
                    <div class="pf-center">
                        <div class="pf-center-dot"></div>
                    </div>
                    
                    <div id="pf-home" class="pf-node pf-home">
                        <div class="pf-connector pf-connector-left"></div>
                        <div class="pf-icon">üè†</div>
                        <div class="pf-value" id="home-power">0 W</div>
                    </div>
                </div>
                
                <!-- Bottom: Battery (optional) -->
                <div id="pf-battery" class="pf-node pf-battery" style="display: none;">
                    <div class="pf-connector pf-connector-top"></div>
                    <div class="pf-icon">üîã</div>
                    <div class="pf-value" id="battery-power">0 W</div>
                </div>
            </div>
            
            <!-- Loads panel (right side on desktop, below on mobile) -->
            <div id="pf-loads" class="pf-loads" style="display: none;">
                <div class="pf-loads-header">Loads</div>
                <div id="pf-loads-list" class="pf-loads-list"></div>
            </div>
        </div>
        
        <!-- Sparkline tooltip -->
        <div id="sparkline-tooltip" class="sparkline-tooltip">
            <canvas id="sparkline-canvas" width="120" height="40"></canvas>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="section-box">
        <div class="chart-header">
            <h3 id="main-chart-title">Energy Consumption</h3>
            <div class="chart-controls">
                <div class="view-selector" id="chart-type-selector" style="display: none;">
                    <button id="consumption-view" class="view-toggle active">Consumption</button>
                    <button id="balance-view" class="view-toggle">Balance</button>
                </div>
                <div class="view-selector">
                    <button id="daily-view" class="view-toggle active">Daily</button>
                    <button id="monthly-view" class="view-toggle">Monthly</button>
                    <button id="yearly-view" class="view-toggle">Yearly</button>
                    <button id="total-view" class="view-toggle">Total</button>
                </div>
                <div class="date-selector">
                    <input type="date" id="date-picker" />
                    <input type="month" id="month-picker" style="display: none;" />
                    <input type="number" id="year-picker" min="2020" max="2100" style="display: none; width: 80px;" />
                    <button id="prev-period" class="nav-button">‚óÄ</button>
                    <button id="next-period" class="nav-button">‚ñ∂</button>
                </div>
            </div>
        </div>
        <div id="consumption-chart" style="position: relative;">
            <div class="chart-loading">üìä Crunching the numbers...</div>
            <canvas id="consumption-chart-canvas" style="display: none;"></canvas>
            <button id="download-csv" class="tooltip" style="position: absolute; top: 2px; right: 2px; display: none;">
                <i class="fas fa-download"></i>
            </button>
        </div>
        <!-- Consumption Sharing Breakdown -->
        <div id="consumption-sharing-section" class="consumption-sharing-section" style="display: none;">
            <div style="position: relative; height: 300px;">
                <canvas id="consumption-pie-canvas" style="display: none;"></canvas>
                <div class="chart-loading">üìä Loading breakdown...</div>
            </div>
        </div>
        <div id="balance-chart" style="position: relative; display: none;">
            <div class="chart-loading">üîã Calculating energy flows...</div>
            <canvas id="balance-chart-canvas" style="display: none;"></canvas>
            <button id="download-balance-csv" class="tooltip" style="position: absolute; top: 2px; right: 2px; display: none;">
                <i class="fas fa-download"></i>
            </button>
        </div>
        <!-- Balance KPIs -->
        <div id="balance-kpis-section" class="energy-kpis" style="display: none;">
            <div id="balance-kpi-grid-import" class="kpi-card">
                <div class="kpi-label">üîå Grid Import</div>
                <div class="kpi-value" id="balance-kpi-grid-import-value">0</div>
                <div class="kpi-unit">kWh</div>
            </div>
            <div id="balance-kpi-grid-export" class="kpi-card">
                <div class="kpi-label">‚ö° Grid Export</div>
                <div class="kpi-value" id="balance-kpi-grid-export-value">0</div>
                <div class="kpi-unit">kWh</div>
            </div>
            <div id="balance-kpi-production" class="kpi-card" style="display: none;">
                <div class="kpi-label"><span id="balance-kpi-production-icon">‚òÄÔ∏è</span> <span id="balance-kpi-production-label">Production</span></div>
                <div class="kpi-value" id="balance-kpi-production-value">0</div>
                <div class="kpi-unit">kWh</div>
            </div>
            <div id="balance-kpi-home" class="kpi-card">
                <div class="kpi-label">üè† Home Consumption</div>
                <div class="kpi-value" id="balance-kpi-home-value">0</div>
                <div class="kpi-unit">kWh</div>
            </div>
            <div id="balance-kpi-self-consumption" class="kpi-card" style="display: none;">
                <div class="kpi-label">üè† Self-Consumption</div>
                <div class="kpi-value" id="balance-kpi-self-consumption-value">0%</div>
            </div>
            <div id="balance-kpi-autosufficiency" class="kpi-card" style="display: none;">
                <div class="kpi-label">üå± Autosufficiency</div>
                <div class="kpi-value" id="balance-kpi-autosufficiency-value">0%</div>
            </div>
            <div id="balance-kpi-battery-charge" class="kpi-card" style="display: none;">
                <div class="kpi-label">üîã Battery Charged</div>
                <div class="kpi-value" id="balance-kpi-battery-charge-value">0</div>
                <div class="kpi-unit">kWh</div>
            </div>
            <div id="balance-kpi-battery-discharge" class="kpi-card" style="display: none;">
                <div class="kpi-label">üîã Battery Discharged</div>
                <div class="kpi-value" id="balance-kpi-battery-discharge-value">0</div>
                <div class="kpi-unit">kWh</div>
            </div>
        </div>
        <!-- Energy KPIs (Consumption View) -->
        <div id="energy-kpis-section" class="energy-kpis" style="display: none;">
            <div id="kpi-grid-import" class="kpi-card">
                <div class="kpi-label">üîå Grid Import</div>
                <div class="kpi-value" id="kpi-grid-import-value">0</div>
                <div class="kpi-unit">kWh</div>
            </div>
            <div id="kpi-grid-export" class="kpi-card">
                <div class="kpi-label">‚ö° Grid Export</div>
                <div class="kpi-value" id="kpi-grid-export-value">0</div>
                <div class="kpi-unit">kWh</div>
            </div>
            <div id="kpi-production" class="kpi-card" style="display: none;">
                <div class="kpi-label">‚òÄÔ∏è Production</div>
                <div class="kpi-value" id="kpi-production-value">0</div>
                <div class="kpi-unit">kWh</div>
            </div>
            <div id="kpi-self-consumption" class="kpi-card" style="display: none;">
                <div class="kpi-label">üè† Self-Consumption</div>
                <div class="kpi-value" id="kpi-self-consumption-value">0%</div>
            </div>
            <div id="kpi-autosufficiency" class="kpi-card" style="display: none;">
                <div class="kpi-label">üå± Autosufficiency</div>
                <div class="kpi-value" id="kpi-autosufficiency-value">0%</div>
            </div>
            <div id="kpi-battery-charge" class="kpi-card" style="display: none;">
                <div class="kpi-label">üîã Battery Charged</div>
                <div class="kpi-value" id="kpi-battery-charge-value">0</div>
                <div class="kpi-unit">kWh</div>
            </div>
            <div id="kpi-battery-discharge" class="kpi-card" style="display: none;">
                <div class="kpi-label">üîã Battery Discharged</div>
                <div class="kpi-value" id="kpi-battery-discharge-value">0</div>
                <div class="kpi-unit">kWh</div>
            </div>
        </div>
    </div>

    <!-- External libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    
    <!-- EnergyMe modules -->
    <script src="/js/api-client.js"></script>
    <script src="/js/data-helpers.js"></script>
    <script src="/js/chart-helpers.js"></script>
    <script src="/js/power-flow.js"></script>
</body>

<script>
    // ============================================================================
    // PAGE STATE
    // ============================================================================
    let channelData = {};
    let meterData = {};
    let availableDates = [];
    let availableMonths = [];
    let availableYears = [];
    let currentView = 'daily';
    let currentChartType = 'consumption';
    let currentDate = null;
    let currentMonth = null;
    let currentYear = null;
    let hasBalanceCapability = false;
    let meterDataUpdateInProgress = false;
    let balanceData = null;

    // ============================================================================
    // INITIALIZATION
    // ============================================================================
    async function initializePage() {
        try {
            // Get channel configuration and current meter data
            [channelData, meterData] = await Promise.all([
                energyApi.getChannelConfig(),
                energyApi.getMeterValues()
            ]);
            
            // Initialize modules with data
            ChannelCache.setChannelData(channelData);
            PowerFlowState.init();

            // Update real-time displays immediately
            PowerFlowHelpers.updateEnergyFlow(meterData, channelData);

            // Load charts in parallel
            loadChartsAsync();

            // Set up event listeners
            setupEventListeners();

        } catch (error) {
            console.error('Error initializing page:', error);
            ChartHelpers.showErrorMessage('Failed to load energy data');
        }
    }
    
    async function loadChartsAsync() {
        try {
            await loadAvailableDates();

            if (availableDates.length > 0) {
                // Prefer the most recent date with an actual daily file
                const actualDailyDates = availableDates.filter(d => ArchiveCache.dailyFilesSet.has(d));
                currentDate = actualDailyDates.length > 0 
                    ? actualDailyDates[actualDailyDates.length - 1] 
                    : availableDates[availableDates.length - 1];
                currentMonth = availableMonths[availableMonths.length - 1];
                currentYear = availableYears[availableYears.length - 1];
                document.getElementById('date-picker').value = currentDate;
                document.getElementById('month-picker').value = currentMonth;
                document.getElementById('year-picker').value = currentYear;
                updateNavigationButtons();
                await loadAndDisplayCharts();
            } else {
                ChartHelpers.showNoDataMessage();
            }
        } catch (error) {
            console.error('Error loading charts:', error);
            ChartHelpers.showErrorMessage('Failed to load chart data');
        }
    }

    async function loadAvailableDates() {
        try {
            const allDates = new Set();
            const allMonths = new Set();
            const allYears = new Set();
            
            // Load daily files
            const dailyFiles = await energyApi.getFileList('energy/daily') || {};
            ArchiveCache.dailyFilesSet.clear();
            Object.keys(dailyFiles)
                .filter(filename => filename.endsWith('.csv.gz') || filename.endsWith('.csv'))
                .map(filename => filename.replace('.csv.gz', '').replace('.csv', ''))
                .forEach(date => {
                    ArchiveCache.dailyFilesSet.add(date);
                    allDates.add(date);
                    allMonths.add(date.substring(0, 7));
                    allYears.add(date.substring(0, 4));
                });
            
            // Load monthly archives
            const monthlyFiles = await energyApi.getFileList('energy/monthly') || {};
            for (const filename of Object.keys(monthlyFiles).filter(f => f.endsWith('.csv.gz'))) {
                const yearMonth = filename.replace('.csv.gz', '');
                allMonths.add(yearMonth);
                allYears.add(yearMonth.substring(0, 4));
                
                const [year, month] = yearMonth.split('-');
                const now = new Date();
                const archiveMonth = new Date(parseInt(year), parseInt(month) - 1, 1);
                const currentMonthDate = new Date(now.getFullYear(), now.getMonth(), 1);

                if (archiveMonth < currentMonthDate) {
                    // Past month: generate all days
                    const daysInMonth = new Date(parseInt(year), parseInt(month), 0).getDate();
                    for (let day = 1; day <= daysInMonth; day++) {
                        allDates.add(`${yearMonth}-${String(day).padStart(2, '0')}`);
                    }
                } else if (archiveMonth.getTime() === currentMonthDate.getTime()) {
                    // Current month: generate days 1 through today
                    const today = now.getDate();
                    for (let day = 1; day <= today; day++) {
                        allDates.add(`${yearMonth}-${String(day).padStart(2, '0')}`);
                    }
                }
            }
            
            // Load yearly archives
            const yearlyFiles = await energyApi.getFileList('energy/yearly') || {};
            for (const filename of Object.keys(yearlyFiles).filter(f => f.endsWith('.csv.gz'))) {
                const year = filename.replace('.csv.gz', '');
                const yearInt = parseInt(year);
                allYears.add(year);

                const now = new Date();
                if (yearInt < now.getFullYear()) {
                    // Past year: generate all 12 months and all dates
                    for (let month = 1; month <= 12; month++) {
                        const ym = `${year}-${String(month).padStart(2, '0')}`;
                        allMonths.add(ym);
                        const daysInMonth = new Date(yearInt, month, 0).getDate();
                        for (let day = 1; day <= daysInMonth; day++) {
                            allDates.add(`${ym}-${String(day).padStart(2, '0')}`);
                        }
                    }
                } else if (yearInt === now.getFullYear()) {
                    // Current year: generate completed months (1 through current_month - 1)
                    const currentMonthNum = now.getMonth() + 1;
                    for (let month = 1; month < currentMonthNum; month++) {
                        const ym = `${year}-${String(month).padStart(2, '0')}`;
                        allMonths.add(ym);
                        const daysInMonth = new Date(yearInt, month, 0).getDate();
                        for (let day = 1; day <= daysInMonth; day++) {
                            allDates.add(`${ym}-${String(day).padStart(2, '0')}`);
                        }
                    }
                }
            }
            
            availableDates = [...allDates].sort();
            availableMonths = [...allMonths].sort();
            availableYears = [...allYears].sort();
        } catch (error) {
            console.error('Error loading available dates:', error);
            availableDates = [];
            availableMonths = [];
            availableYears = [];
        }
    }

    // ============================================================================
    // EVENT LISTENERS
    // ============================================================================
    function setupEventListeners() {
        document.getElementById('consumption-view').addEventListener('click', () => switchChartType('consumption'));
        document.getElementById('balance-view').addEventListener('click', () => switchChartType('balance'));
        
        document.getElementById('daily-view').addEventListener('click', () => switchView('daily'));
        document.getElementById('monthly-view').addEventListener('click', () => switchView('monthly'));
        document.getElementById('yearly-view').addEventListener('click', () => switchView('yearly'));
        document.getElementById('total-view').addEventListener('click', () => switchView('total'));
        
        document.getElementById('date-picker').addEventListener('change', async (e) => {
            currentDate = e.target.value;
            updateNavigationButtons();
            await loadAndDisplayCharts();
        });
        
        document.getElementById('month-picker').addEventListener('change', async (e) => {
            currentMonth = e.target.value;
            updateNavigationButtons();
            await loadAndDisplayCharts();
        });
        
        document.getElementById('year-picker').addEventListener('change', async (e) => {
            currentYear = e.target.value;
            updateNavigationButtons();
            await loadAndDisplayCharts();
        });

        document.getElementById('prev-period').addEventListener('click', navigatePrevious);
        document.getElementById('next-period').addEventListener('click', navigateNext);
        
        // Initialize view visibility (consumption by default)
        switchChartType(currentChartType);
    }
    
    async function navigatePrevious() {
        if (currentView === 'total') return;
        const lists = { daily: availableDates, monthly: availableMonths, yearly: availableYears };
        const current = { daily: currentDate, monthly: currentMonth, yearly: currentYear };
        const pickers = { daily: 'date-picker', monthly: 'month-picker', yearly: 'year-picker' };
        
        const list = lists[currentView];
        const currentIndex = list.indexOf(current[currentView]);
        
        if (currentIndex > 0) {
            const newValue = list[currentIndex - 1];
            if (currentView === 'daily') currentDate = newValue;
            else if (currentView === 'monthly') currentMonth = newValue;
            else currentYear = newValue;
            
            document.getElementById(pickers[currentView]).value = newValue;
            updateNavigationButtons();
            await loadAndDisplayCharts();
        }
    }
    
    async function navigateNext() {
        if (currentView === 'total') return;
        const lists = { daily: availableDates, monthly: availableMonths, yearly: availableYears };
        const current = { daily: currentDate, monthly: currentMonth, yearly: currentYear };
        const pickers = { daily: 'date-picker', monthly: 'month-picker', yearly: 'year-picker' };
        
        const list = lists[currentView];
        const currentIndex = list.indexOf(current[currentView]);
        
        if (currentIndex < list.length - 1) {
            const newValue = list[currentIndex + 1];
            if (currentView === 'daily') currentDate = newValue;
            else if (currentView === 'monthly') currentMonth = newValue;
            else currentYear = newValue;
            
            document.getElementById(pickers[currentView]).value = newValue;
            updateNavigationButtons();
            await loadAndDisplayCharts();
        }
    }
    
    function switchView(view) {
        currentView = view;
        
        document.getElementById('daily-view').classList.toggle('active', view === 'daily');
        document.getElementById('monthly-view').classList.toggle('active', view === 'monthly');
        document.getElementById('yearly-view').classList.toggle('active', view === 'yearly');
        document.getElementById('total-view').classList.toggle('active', view === 'total');
        
        document.getElementById('date-picker').style.display = view === 'daily' ? 'block' : 'none';
        document.getElementById('month-picker').style.display = view === 'monthly' ? 'block' : 'none';
        document.getElementById('year-picker').style.display = view === 'yearly' ? 'block' : 'none';
        
        const dateSelector = document.querySelector('.date-selector');
        dateSelector.style.display = view === 'total' ? 'none' : 'flex';
        
        updateNavigationButtons();
        loadAndDisplayCharts();
    }
    
    function switchChartType(chartType) {
        currentChartType = chartType;
        
        document.getElementById('consumption-view').classList.toggle('active', chartType === 'consumption');
        document.getElementById('balance-view').classList.toggle('active', chartType === 'balance');
        
        document.getElementById('consumption-chart').style.display = chartType === 'consumption' ? 'block' : 'none';
        document.getElementById('balance-chart').style.display = chartType === 'balance' ? 'block' : 'none';
        
        // Toggle between consumption sharing and balance KPIs
        const consumptionSharingSection = document.getElementById('consumption-sharing-section');
        const balanceKpisSection = document.getElementById('balance-kpis-section');
        const energyKpisSection = document.getElementById('energy-kpis-section');
        
        if (chartType === 'consumption') {
            if (consumptionSharingSection) consumptionSharingSection.style.display = 'block';
            if (balanceKpisSection) balanceKpisSection.style.display = 'none';
            if (energyKpisSection) energyKpisSection.style.display = 'none';
        } else {
            if (consumptionSharingSection) consumptionSharingSection.style.display = 'none';
            if (balanceKpisSection) balanceKpisSection.style.display = 'flex';
            if (energyKpisSection) energyKpisSection.style.display = 'none';
        }
        
        document.getElementById('main-chart-title').textContent = chartType === 'consumption' ? 'Energy Consumption' : 'Energy Balance';
    }

    function updateNavigationButtons() {
        const lists = { daily: availableDates, monthly: availableMonths, yearly: availableYears, total: [] };
        const current = { daily: currentDate, monthly: currentMonth, yearly: currentYear, total: null };
        
        const list = lists[currentView];
        const currentIndex = list.length > 0 ? list.indexOf(current[currentView]) : -1;
        
        document.getElementById('prev-period').disabled = currentIndex <= 0;
        document.getElementById('next-period').disabled = currentIndex < 0 || currentIndex >= list.length - 1;
    }

    // ============================================================================
    // CHART LOADING
    // ============================================================================
    async function loadAndDisplayCharts() {
        if (currentView === 'daily' && !currentDate) return;
        if (currentView === 'monthly' && !currentMonth) return;
        if (currentView === 'yearly' && !currentYear) return;

        try {
            ChartHelpers.showLoadingMessage(currentChartType);
            
            if (currentView === 'daily') await loadDailyCharts();
            else if (currentView === 'monthly') await loadMonthlyCharts();
            else if (currentView === 'yearly') await loadYearlyCharts();
            else if (currentView === 'total') await loadTotalCharts();
            
        } catch (error) {
            console.error('Error loading charts:', error);
            const periods = { daily: currentDate, monthly: currentMonth, yearly: currentYear, total: 'all time' };
            ChartHelpers.showErrorMessage(`Failed to load energy data for ${periods[currentView]}`);
        }
    }
    
    async function loadDailyCharts() {
        const selectedLocalDate = new Date(currentDate + 'T00:00:00');
        const localEndOfDay = new Date(selectedLocalDate);
        localEndOfDay.setDate(localEndOfDay.getDate() + 1);
        
        const utcDatesNeeded = new Set();
        utcDatesNeeded.add(selectedLocalDate.toISOString().substring(0, 10));
        utcDatesNeeded.add(localEndOfDay.toISOString().substring(0, 10));
        const prevDay = new Date(selectedLocalDate);
        prevDay.setDate(prevDay.getDate() - 1);
        utcDatesNeeded.add(prevDay.toISOString().substring(0, 10));
        
        let allEnergyData = [];
        for (const utcDate of utcDatesNeeded) {
            try {
                const csvData = await DataHelpers.loadDailyCsvData(utcDate);
                allEnergyData = allEnergyData.concat(DataHelpers.parseCsvEnergyData(csvData));
            } catch (e) { /* Date may not exist */ }
        }
        
        if (allEnergyData.length === 0) throw new Error('No data available');
        
        const nextLocalDate = new Date(currentDate + 'T00:00:00');
        nextLocalDate.setDate(nextLocalDate.getDate() + 1);
        const nextLocalDateStr = nextLocalDate.toLocaleDateString('sv-SE');
        
        const energyData = allEnergyData.filter(entry => {
            const entryDate = new Date(entry.timestamp);
            const entryLocalDate = entryDate.toLocaleDateString('sv-SE');
            if (entryLocalDate === currentDate) return true;
            if (entryLocalDate === nextLocalDateStr && entryDate.getHours() === 0) return true;
            return false;
        });
        
        if (energyData.length === 0) throw new Error('No data available');
        
        const hourlyData = calculateHourlyConsumption(energyData, currentDate);
        const totalConsumption = calculateTotalConsumption(energyData.filter(entry => {
            return new Date(entry.timestamp).toLocaleDateString('sv-SE') === currentDate;
        }));
        
        ChartHelpers.restoreChartCanvases(currentChartType);
        
        ChartHelpers.updateConsumptionChart(hourlyData.imported, 'daily', hourlyData.exported, channelData, currentChartType);
        ChartHelpers.updateConsumptionSharing(hourlyData.imported, 'daily', channelData, currentChartType);
        hasBalanceCapability = ChannelCache.production.length > 0 || ChannelCache.battery.length > 0 || ChannelCache.inverter.length > 0;
        balanceData = ChartHelpers.updateBalanceChart(hourlyData.rawHourlyImport, 'daily', hourlyData.rawHourlyImport, hourlyData.rawHourlyExport, hasBalanceCapability);
        ChartHelpers.updateBalanceKPIView(balanceData, hasBalanceCapability);
        
        setupCsvDownload(hourlyData.imported, 'daily');
    }
    
    async function loadMonthlyCharts() {
        let allEnergyData = [];

        // Load monthly archive (DataHelpers falls back to yearly archive)
        try {
            const csvData = await DataHelpers.loadMonthlyCsvData(currentMonth);
            allEnergyData = DataHelpers.parseCsvEnergyData(csvData);
        } catch (error) { /* No data for this month */ }

        // For current month: also load daily files for fresh intraday data
        const now = new Date();
        const currentYearMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        if (currentMonth === currentYearMonth) {
            for (const date of ArchiveCache.dailyFilesSet) {
                if (date.startsWith(currentMonth)) {
                    try {
                        const csvData = await DataHelpers.loadDailyCsvData(date);
                        allEnergyData = allEnergyData.concat(DataHelpers.parseCsvEnergyData(csvData));
                    } catch (error) { /* Daily file may not exist */ }
                }
            }
        }

        if (allEnergyData.length === 0) throw new Error('No data available');
        
        const dailyConsumptions = {};
        const monthlyRawImported = {};
        const monthlyRawExported = {};
        const dailyRawImport = {};
        const dailyRawExport = {};
        const dailyExported = {};
        
        const dataByDate = {};
        allEnergyData.forEach(entry => {
            const date = entry.timestamp.substring(0, 10);
            if (!dataByDate[date]) dataByDate[date] = [];
            dataByDate[date].push(entry);
        });
        
        Object.keys(dataByDate).sort().forEach(date => {
            const dayData = dataByDate[date];
            const dailyData = calculateTotalConsumption(dayData);
            const day = date.substring(8, 10);
            dailyConsumptions[day] = dailyData.imported;
            if (Object.keys(dailyData.exported).length > 0) dailyExported[day] = dailyData.exported;
            dailyRawImport[day] = dailyData.rawImported;
            dailyRawExport[day] = dailyData.rawExported;
            
            Object.keys(dailyData.rawImported).forEach(channel => {
                if (!monthlyRawImported[channel]) monthlyRawImported[channel] = 0;
                monthlyRawImported[channel] += dailyData.rawImported[channel];
            });
            Object.keys(dailyData.rawExported).forEach(channel => {
                if (!monthlyRawExported[channel]) monthlyRawExported[channel] = 0;
                monthlyRawExported[channel] += dailyData.rawExported[channel];
            });
        });
        
        ChartHelpers.restoreChartCanvases(currentChartType);
        
        ChartHelpers.updateConsumptionChart(dailyConsumptions, 'monthly', dailyExported, channelData, currentChartType);
        ChartHelpers.updateConsumptionSharing(dailyConsumptions, 'monthly', channelData, currentChartType);
        hasBalanceCapability = ChannelCache.production.length > 0 || ChannelCache.battery.length > 0 || ChannelCache.inverter.length > 0;
        balanceData = ChartHelpers.updateBalanceChart(dailyRawImport, 'monthly', dailyRawImport, dailyRawExport, hasBalanceCapability);
        ChartHelpers.updateBalanceKPIView(balanceData, hasBalanceCapability);
        
        setupCsvDownload(dailyConsumptions, 'monthly');
    }

    async function loadYearlyCharts() {
        let allEnergyData = [];

        // Load yearly archive (contains all completed months for this year)
        try {
            const csvData = await DataHelpers.loadYearlyCsvData(currentYear);
            allEnergyData = DataHelpers.parseCsvEnergyData(csvData);
        } catch (error) { /* No yearly archive */ }

        // For current year: also load current month + today's daily file
        const now = new Date();
        if (parseInt(currentYear) === now.getFullYear()) {
            const currentYearMonth = `${currentYear}-${String(now.getMonth() + 1).padStart(2, '0')}`;

            // Load monthly archive for current month
            try {
                const csvData = await DataHelpers.loadMonthlyCsvData(currentYearMonth);
                allEnergyData = allEnergyData.concat(DataHelpers.parseCsvEnergyData(csvData));
            } catch (error) { /* No monthly file yet */ }

            // Load today's daily files for fresh intraday data
            for (const date of ArchiveCache.dailyFilesSet) {
                if (date.startsWith(currentYearMonth)) {
                    try {
                        const csvData = await DataHelpers.loadDailyCsvData(date);
                        allEnergyData = allEnergyData.concat(DataHelpers.parseCsvEnergyData(csvData));
                    } catch (error) { /* Daily file may not exist */ }
                }
            }
        }

        if (allEnergyData.length === 0) throw new Error('No data available');
        
        const monthlyConsumptions = {};
        const monthlyExported = {};
        const yearlyRawImported = {};
        const yearlyRawExported = {};
        const monthlyRawImport = {};
        const monthlyRawExport = {};
        
        const dataByMonth = {};
        allEnergyData.forEach(entry => {
            const month = entry.timestamp.substring(5, 7);
            if (!dataByMonth[month]) dataByMonth[month] = [];
            dataByMonth[month].push(entry);
        });
        
        Object.keys(dataByMonth).sort().forEach(month => {
            const monthData = dataByMonth[month];
            const monthConsumptionData = calculateTotalConsumption(monthData);
            monthlyConsumptions[month] = monthConsumptionData.imported;
            if (Object.keys(monthConsumptionData.exported).length > 0) monthlyExported[month] = monthConsumptionData.exported;
            monthlyRawImport[month] = monthConsumptionData.rawImported;
            monthlyRawExport[month] = monthConsumptionData.rawExported;
            
            Object.keys(monthConsumptionData.rawImported).forEach(channel => {
                if (!yearlyRawImported[channel]) yearlyRawImported[channel] = 0;
                yearlyRawImported[channel] += monthConsumptionData.rawImported[channel];
            });
            Object.keys(monthConsumptionData.rawExported).forEach(channel => {
                if (!yearlyRawExported[channel]) yearlyRawExported[channel] = 0;
                yearlyRawExported[channel] += monthConsumptionData.rawExported[channel];
            });
        });
        
        ChartHelpers.restoreChartCanvases(currentChartType);
        
        ChartHelpers.updateConsumptionChart(monthlyConsumptions, 'yearly', monthlyExported, channelData, currentChartType);
        ChartHelpers.updateConsumptionSharing(monthlyConsumptions, 'yearly', channelData, currentChartType);
        hasBalanceCapability = ChannelCache.production.length > 0 || ChannelCache.battery.length > 0 || ChannelCache.inverter.length > 0;
        balanceData = ChartHelpers.updateBalanceChart(monthlyRawImport, 'yearly', monthlyRawImport, monthlyRawExport, hasBalanceCapability);
        ChartHelpers.updateBalanceKPIView(balanceData, hasBalanceCapability);
        
        setupCsvDownload(monthlyConsumptions, 'yearly');
    }

    async function loadTotalCharts() {
        let allEnergyData = [];

        const now = new Date();
        const currentYearStr = String(now.getFullYear());

        for (const year of availableYears) {
            // Load yearly archive
            try {
                const csvData = await DataHelpers.loadYearlyCsvData(year);
                allEnergyData = allEnergyData.concat(DataHelpers.parseCsvEnergyData(csvData));
            } catch (error) { /* No yearly archive for this year */ }

            // For current year: also load current month + daily files
            if (year === currentYearStr) {
                const currentYearMonth = `${year}-${String(now.getMonth() + 1).padStart(2, '0')}`;

                try {
                    const csvData = await DataHelpers.loadMonthlyCsvData(currentYearMonth);
                    allEnergyData = allEnergyData.concat(DataHelpers.parseCsvEnergyData(csvData));
                } catch (error) { /* No monthly file yet */ }

                for (const date of ArchiveCache.dailyFilesSet) {
                    if (date.startsWith(currentYearMonth)) {
                        try {
                            const csvData = await DataHelpers.loadDailyCsvData(date);
                            allEnergyData = allEnergyData.concat(DataHelpers.parseCsvEnergyData(csvData));
                        } catch (error) { /* Daily file may not exist */ }
                    }
                }
            }
        }

        if (allEnergyData.length === 0) throw new Error('No data available');

        const yearlyConsumptions = {};
        const yearlyExported = {};
        const totalRawImported = {};
        const totalRawExported = {};
        const yearlyRawImport = {};
        const yearlyRawExport = {};

        const dataByYear = {};
        allEnergyData.forEach(entry => {
            const year = entry.timestamp.substring(0, 4);
            if (!dataByYear[year]) dataByYear[year] = [];
            dataByYear[year].push(entry);
        });

        Object.keys(dataByYear).sort().forEach(year => {
            const yearData = dataByYear[year];
            const yearConsumptionData = calculateTotalConsumption(yearData);
            yearlyConsumptions[year] = yearConsumptionData.imported;
            if (Object.keys(yearConsumptionData.exported).length > 0) yearlyExported[year] = yearConsumptionData.exported;
            yearlyRawImport[year] = yearConsumptionData.rawImported;
            yearlyRawExport[year] = yearConsumptionData.rawExported;

            Object.keys(yearConsumptionData.rawImported).forEach(channel => {
                if (!totalRawImported[channel]) totalRawImported[channel] = 0;
                totalRawImported[channel] += yearConsumptionData.rawImported[channel];
            });
            Object.keys(yearConsumptionData.rawExported).forEach(channel => {
                if (!totalRawExported[channel]) totalRawExported[channel] = 0;
                totalRawExported[channel] += yearConsumptionData.rawExported[channel];
            });
        });

        ChartHelpers.restoreChartCanvases(currentChartType);

        ChartHelpers.updateConsumptionChart(yearlyConsumptions, 'total', yearlyExported, channelData, currentChartType);
        ChartHelpers.updateConsumptionSharing(yearlyConsumptions, 'total', channelData, currentChartType);
        hasBalanceCapability = ChannelCache.production.length > 0 || ChannelCache.battery.length > 0 || ChannelCache.inverter.length > 0;
        balanceData = ChartHelpers.updateBalanceChart(yearlyRawImport, 'total', yearlyRawImport, yearlyRawExport, hasBalanceCapability);
        ChartHelpers.updateBalanceKPIView(balanceData, hasBalanceCapability);

        setupCsvDownload(yearlyConsumptions, 'total');
    }

    // ============================================================================
    // DATA PROCESSING
    // ============================================================================
    function calculateHourlyConsumption(energyData, targetLocalDate) {
        const sortedData = energyData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        
        const channelSequences = {};
        sortedData.forEach(entry => {
            if (!channelSequences[entry.channel]) channelSequences[entry.channel] = [];
            const date = new Date(entry.timestamp);
            channelSequences[entry.channel].push({
                timestamp: entry.timestamp,
                energyImported: entry.activeImported,
                energyExported: entry.activeExported || 0,
                hour: date.getHours().toString().padStart(2, '0'),
                localDate: date.toLocaleDateString('sv-SE')
            });
        });
        
        const consumption = {};
        const exportData = {};
        
        Object.keys(channelSequences).forEach(channel => {
            const sequence = channelSequences[channel];
            
            for (let i = 1; i < sequence.length; i++) {
                const current = sequence[i];
                const previous = sequence[i - 1];
                
                if (targetLocalDate && previous.localDate !== targetLocalDate) continue;
                
                const hourlyImport = Math.max(0, (current.energyImported - previous.energyImported) / 1000);
                const hourlyExport = Math.max(0, (current.energyExported - previous.energyExported) / 1000);
                
                if (!consumption[previous.hour]) consumption[previous.hour] = {};
                if (!exportData[previous.hour]) exportData[previous.hour] = {};
                
                consumption[previous.hour][channel] = hourlyImport;
                if (hourlyExport > 0) exportData[previous.hour][channel] = hourlyExport;
            }
        });
        
        const excludeFromOther = ChannelCache.excludeFromOther;
        const hasGridChannel = ChannelCache.hasGrid;
        const hasLoads = DataHelpers.hasLoadSubChannels(channelSequences, excludeFromOther);
        
        const rawHourlyImport = {};
        const rawHourlyExport = {};
        Object.keys(consumption).forEach(hour => {
            const hourNum = parseInt(hour);
            if (hourNum >= 0 && hourNum <= 23) {
                rawHourlyImport[hour] = { ...consumption[hour] };
                rawHourlyExport[hour] = exportData[hour] ? { ...exportData[hour] } : {};
            }
        });
        
        Object.keys(consumption).forEach(hour => {
            const hourNum = parseInt(hour);
            if (hourNum < 0 || hourNum > 23) return;
            
            if (hasGridChannel && hasLoads) {
                consumption[hour]['Other'] = DataHelpers.calculateOtherConsumption(consumption[hour], excludeFromOther);
            }
            
            excludeFromOther.forEach(ch => delete consumption[hour][ch]);
            if (exportData[hour]) {
                excludeFromOther.forEach(ch => delete exportData[hour][ch]);
            }
        });
        
        const filteredConsumption = {};
        const filteredExport = {};
        
        Object.keys(consumption).forEach(hour => {
            const hourNum = parseInt(hour);
            if (hourNum >= 0 && hourNum <= 23) {
                filteredConsumption[hour] = consumption[hour];
                if (exportData[hour]) filteredExport[hour] = exportData[hour];
            }
        });
        
        return { imported: filteredConsumption, exported: filteredExport, rawHourlyImport, rawHourlyExport };
    }

    function calculateTotalConsumption(energyData) {
        const latestData = {};
        const firstData = {};
        const latestExportData = {};
        const firstExportData = {};
        
        energyData.forEach(entry => {
            if (!firstData[entry.channel]) firstData[entry.channel] = entry.activeImported;
            latestData[entry.channel] = entry.activeImported;
            
            if (entry.activeExported !== undefined) {
                if (!firstExportData[entry.channel]) firstExportData[entry.channel] = entry.activeExported;
                latestExportData[entry.channel] = entry.activeExported;
            }
        });
        
        const rawConsumption = {};
        Object.keys(latestData).forEach(channel => {
            const dailyConsumption = (latestData[channel] - (firstData[channel] || 0)) / 1000;
            if (dailyConsumption > 0) rawConsumption[channel] = dailyConsumption;
        });
        
        const rawExported = {};
        Object.keys(latestExportData).forEach(channel => {
            const dailyExport = (latestExportData[channel] - (firstExportData[channel] || 0)) / 1000;
            if (dailyExport > 0) rawExported[channel] = dailyExport;
        });
        
        const totalConsumption = { ...rawConsumption };
        const totalExported = { ...rawExported };
        
        const excludeFromOther = ChannelCache.excludeFromOther;
        const hasGridChannel = ChannelCache.hasGrid;
        const hasLoads = DataHelpers.hasLoadSubChannels(totalConsumption, excludeFromOther);
        
        if (hasGridChannel && hasLoads) {
            totalConsumption['Other'] = DataHelpers.calculateOtherConsumption(totalConsumption, excludeFromOther);
        }
        
        excludeFromOther.forEach(ch => delete totalConsumption[ch]);
        excludeFromOther.forEach(ch => delete totalExported[ch]);

        return { imported: totalConsumption, exported: totalExported, rawImported: rawConsumption, rawExported: rawExported };
    }

    // ============================================================================
    // CSV DOWNLOAD
    // ============================================================================
    function setupCsvDownload(consumptionData, viewType) {
        const downloadBtn = document.getElementById('download-csv');
        downloadBtn.onclick = function() {
            const periods = Object.keys(consumptionData).sort();
            const channels = new Set();
            periods.forEach(period => Object.keys(consumptionData[period]).forEach(ch => channels.add(ch)));
            
            const channelArray = [...channels].sort((a, b) => {
                if (a === 'Other') return 1;
                if (b === 'Other') return -1;
                return parseInt(a) - parseInt(b);
            });
            
            let csvContent = "data:text/csv;charset=utf-8,";
            const periodLabels = { daily: 'Hour', monthly: 'Day', yearly: 'Month', total: 'Year' };
            const periodLabel = periodLabels[viewType] || 'Period';
            csvContent += periodLabel + "," + channelArray.map(ch => ChartHelpers.getChannelLabel(ch, channelData)).join(",") + "\n";
            
            periods.forEach(period => {
                const periodDisplay = viewType === 'daily' ? period + ":00" : period;
                const row = [periodDisplay, ...channelArray.map(ch => (consumptionData[period][ch] || 0).toFixed(3))];
                csvContent += row.join(",") + "\n";
            });
            
            const link = document.createElement("a");
            const dateStrs = { daily: currentDate, monthly: currentMonth, yearly: currentYear, total: 'all' };
            const dateStr = dateStrs[viewType] || 'data';
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", `energy_consumption_${viewType}_${dateStr}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        
        // Setup balance CSV download
        const balanceDownloadBtn = document.getElementById('download-balance-csv');
        balanceDownloadBtn.onclick = function() {
            if (!balanceData) return;
            
            let csvContent = "data:text/csv;charset=utf-8,";
            const balancePeriodLabels = { daily: 'Hour', monthly: 'Day', yearly: 'Month', total: 'Year' };
            const periodLabel = balancePeriodLabels[viewType] || 'Period';
            csvContent += [periodLabel, 'Grid (kWh)', 'PV (kWh)', 'Battery (kWh)', 'Home (kWh)'].join(",") + "\n";
            
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            // For total view, use the sorted year keys from the consumption data
            const balancePeriodKeys = viewType === 'total' ? Object.keys(consumptionData).sort() : null;
            for (let i = 0; i < balanceData.grid.length; i++) {
                let periodDisplay;
                if (viewType === 'daily') periodDisplay = `${i}:00`;
                else if (viewType === 'monthly') periodDisplay = String(i + 1).padStart(2, '0');
                else if (viewType === 'total') periodDisplay = balancePeriodKeys ? balancePeriodKeys[i] : String(i);
                else periodDisplay = monthNames[i] || String(i + 1);
                
                csvContent += [periodDisplay, balanceData.grid[i].toFixed(3), balanceData.pv[i].toFixed(3), 
                    balanceData.battery[i].toFixed(3), balanceData.homeConsumption[i].toFixed(3)].join(",") + "\n";
            }
            
            const link = document.createElement("a");
            const balanceDateStrs = { daily: currentDate, monthly: currentMonth, yearly: currentYear, total: 'all' };
            const dateStr = balanceDateStrs[viewType] || 'data';
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", `energy_balance_${viewType}_${dateStr}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
    }

    // ============================================================================
    // STARTUP CHECKS
    // ============================================================================
    async function fetchFirmwareUpdateInfo() {
        try {
            const data = await energyApi.getFirmwareUpdateInfo();
            if (data.isLatest === false) {
                document.querySelector('.buttonNavigation[href="/update"]').innerHTML += ' &#x1F514';
            }
        } catch (error) {
            console.error('Error fetching firmware update info:', error);
        }
    }

    async function checkDefaultPassword() {
        try {
            const authStatus = await energyApi.getAuthStatus();
            if (authStatus.usingDefaultPassword) {
                alert('‚ö†Ô∏è Security Warning: You are still using the default password!\n\nPlease change your password immediately in the Configuration page to secure your device.');
            }
        } catch (error) {
            console.error('Error checking auth status:', error);
        }
    }

    // ============================================================================
    // PAGE STARTUP
    // ============================================================================
    document.addEventListener('DOMContentLoaded', async () => {
        ChartHelpers.initSparkline();
        
        await initializePage();
        await fetchFirmwareUpdateInfo();
        await checkDefaultPassword();
        
        PowerFlowHelpers.setupSparklineHovers(PowerFlowState.flowHistory, PowerFlowState.loadHistory, PowerFlowConfig.NODE_COLORS);
        
        // Real-time meter data updates
        setInterval(async () => {
            if (meterDataUpdateInProgress) return;

            try {
                meterDataUpdateInProgress = true;
                meterData = await energyApi.getMeterValues();
                PowerFlowHelpers.updateEnergyFlow(meterData, channelData);
            } catch (error) {
                console.error('Error updating meter data:', error);
            } finally {
                meterDataUpdateInProgress = false;
            }
        }, 1000);
    });
</script>

</html>
